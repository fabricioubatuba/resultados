<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Controle de Chegadas v2 - teste-c702e</title>
  <style>
    :root{--accent:#1e90ff;--accent-2:#ff8a00;font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial}
    body{margin:0;background:#f6f8fb;color:#111;font-family:var(--font, Inter), sans-serif}
    header{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#fff;padding:12px 18px;display:flex;align-items:center;justify-content:space-between}
    .brand{font-weight:700}
    .container{max-width:1100px;margin:20px auto;padding:12px}
    .card{background:#fff;border-radius:10px;padding:16px;box-shadow:0 6px 18px rgba(20,30,60,0.06);}
    .big-input{font-size:72px;letter-spacing:10px;padding:28px 20px;text-align:center;width:720px;box-sizing:border-box;border-radius:8px;border:1px solid #ddd}
    .row{display:flex;gap:12px;align-items:center}
    button{background:var(--accent);color:#fff;border:none;padding:10px 14px;border-radius:8px;cursor:pointer}
    button.secondary{background:#e6eefc;color:#1e3a8a}
    .ghost{background:transparent;border:1px solid #ddd;color:#333}
    nav{
  display: flex;
  gap: 8px;
  margin-top: 24px;   /* ajusta o espaçamento vertical */
  flex-basis: 100%;   /* força o nav a quebrar para a próxima linha */
  justify-content: flex-start; /* mantém os botões alinhados à esquerda */
}
    table{width:100%;border-collapse:collapse}
    th,td{padding:6px 8px;border-bottom:1px solid #f0f0f0;text-align:left}
    .small{font-size:13px;color:#666}
    .last5{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .pill{background:#f1f5f9;padding:6px 10px;border-radius:999px;font-weight:600;cursor:pointer}
    .hidden{display:none}
    .filters{display:flex;gap:8px;align-items:center}
    form.modal{background:#fff;border:1px solid #ccc;border-radius:10px;padding:16px;box-shadow:0 8px 30px rgba(0,0,0,0.18);position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:60;min-width:320px}
    form.modal input, form.modal select{width:100%;padding:8px;margin:6px 0;border:1px solid #ccc;border-radius:6px;box-sizing:border-box}
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,0.35);z-index:50}
    .form-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:8px}
    .error{color:#b00020}
    @media(max-width:900px){ .big-input{width:100%;font-size:48px;padding:16px} .container{padding:8px} nav{flex-wrap:wrap} }
  </style>
</head>
<body>
  <header>
    <div class="brand">Controle de Chegadas v2</div>
    <div id="user-area" class="small"></div>
  </header>

  <div class="container">
    <!-- Auth -->
    <div class="card" id="auth-card">
      <h3>Entrar</h3>
      <div style="display:flex;gap:8px;align-items:center;margin-top:8px;flex-wrap:wrap">
        <input id="email" placeholder="email" style="padding:8px;border-radius:6px;border:1px solid #ddd" />
        <input id="password" placeholder="senha" type="password" style="padding:8px;border-radius:6px;border:1px solid #ddd" />
        <button id="btn-login">Entrar</button>
        <button id="btn-register" class="secondary">Criar conta</button>
      </div>
      <p class="small">Autenticação via Firebase (Email/Senha). Faça login para acessar o painel.</p>
      <p class="small error" id="auth-error" style="display:none"></p>
    </div>

    <!-- App -->
    <div class="card hidden" id="app-card">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
        <div style="flex:1;min-width:280px">
          <div style="font-size:14px;color:#444">Entrada rápida de número (foco automático) — apenas pressione <strong>Enter</strong></div>
          <div style="margin-top:8px;display:flex;align-items:center;gap:12px;flex-wrap:wrap">
            <input id="numero-input" maxlength="10" class="big-input" placeholder="0000" autocomplete="off" inputmode="numeric" />
            <div style="display:flex;flex-direction:column;gap:8px">
              <button id="btn-limpar" class="ghost">Limpar</button>
            </div>
          </div>
          <div class="small" style="margin-top:8px">Últimos 5 números digitados</div>
          <div class="last5" id="last5"></div>
        </div>

        <nav>
          <button id="nav-entrada" class="secondary">Entrada Rápida</button>
          <button id="nav-listagem" class="secondary">Listagem Completa</button>
          <button id="nav-largadas" class="secondary">Largadas</button>
          <button id="nav-resultados" class="secondary">Resultados</button>
          <button id="btn-logout" class="ghost">Sair</button>
        </nav>
      </div>

      <hr style="margin:12px 0" />

      <div id="pages">
        <!-- ENTRADA -->
        <div id="page-entrada">
          <div style="margin-top:12px">
            <p class="small">Aponte o leitor de código de barras e pressione Enter. O cursor permanecerá aqui enquanto estiver nesta tela.</p>
          </div>
        </div>

        <!-- LISTAGEM -->
        <div id="page-listagem" class="hidden">
          <h4>Listagem Completa</h4>
          <div class="row" style="margin:8px 0;align-items:center">
            <button id="btn-add-athlete" class="secondary">Novo Atleta</button>
            <input type="file" id="csv-upload" accept=".csv" />
            <input id="search-listagem" placeholder="Pesquisar por nome ou número" style="flex:1;padding:8px;border-radius:6px;border:1px solid #ddd" />
          </div>
          <div id="table-listagem"></div>
        </div>

        <!-- LARGADAS -->
        <div id="page-largadas" class="hidden">
          <h4>Largadas</h4>
          <div style="display:flex;gap:8px;margin-bottom:8px;align-items:center">
            <button id="btn-add-largada" class="secondary">Nova Largada</button>
          </div>
          <div id="table-largadas"></div>
        </div>

        <!-- RESULTADOS -->
        <div id="page-resultados" class="hidden">
          <h4>Resultados</h4>
          <div style="display:flex;gap:8px;align-items:center;margin-bottom:12px;flex-wrap:wrap">
            <div class="filters" style="align-items:center">
              <label class="small">Modalidade</label>
              <select id="f-modalidade"><option value="">Todas</option></select>
              <label class="small">Categoria</label>
              <select id="f-categoria"><option value="">Todas</option></select>
              <label class="small">Gênero</label>
              <select id="f-genero"><option value="">Todos</option></select>
              <button id="btn-aplicar-filtro" class="secondary">Aplicar</button>
            </div>
            <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
              <button id="btn-export" class="secondary">Exportar CSV</button>
            </div>
          </div>
          <div id="table-resultados"></div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    const firebaseConfig = {
      apiKey: "AIzaSyBZqXrKnRGvM0BG5qrrE38R8zR25tacOzw",
      authDomain: "teste-c702e.firebaseapp.com",
      databaseURL: "https://teste-c702e-default-rtdb.firebaseio.com",
      projectId: "teste-c702e",
      storageBucket: "teste-c702e.firebasestorage.app",
      messagingSenderId: "478905955045",
      appId: "1:478905955045:web:86bc4f77bf4296c6e85a0c"
    };

    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js';
    import { getDatabase, ref, set, get, onValue, child, remove, update } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js';

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    const authCard = document.getElementById('auth-card');
    const appCard = document.getElementById('app-card');
    const userArea = document.getElementById('user-area');
    const emailInput = document.getElementById('email');
    const passInput = document.getElementById('password');
    const btnLogin = document.getElementById('btn-login');
    const btnRegister = document.getElementById('btn-register');
    const btnLogout = document.getElementById('btn-logout');
    const authError = document.getElementById('auth-error');

    const numeroInput = document.getElementById('numero-input');
    const btnLimpar = document.getElementById('btn-limpar');

    const navEntrada = document.getElementById('nav-entrada');
    const navListagem = document.getElementById('nav-listagem');
    const navLargadas = document.getElementById('nav-largadas');
    const navResultados = document.getElementById('nav-resultados');

    const pageEntrada = document.getElementById('page-entrada');
    const pageListagem = document.getElementById('page-listagem');
    const pageLargadas = document.getElementById('page-largadas');
    const pageResultados = document.getElementById('page-resultados');

    const tableListagem = document.getElementById('table-listagem');
    const tableLargadas = document.getElementById('table-largadas');
    const tableResultados = document.getElementById('table-resultados');

    const btnAddAthlete = document.getElementById('btn-add-athlete');
    const csvUpload = document.getElementById('csv-upload');
    const searchListagem = document.getElementById('search-listagem');
    const btnAddLargada = document.getElementById('btn-add-largada');

    const fModalidade = document.getElementById('f-modalidade');
    const fCategoria = document.getElementById('f-categoria');
    const fGenero = document.getElementById('f-genero');
    const btnAplicarFiltro = document.getElementById('btn-aplicar-filtro');
    const btnExport = document.getElementById('btn-export');

    function padNum(n){ return String(n).padStart(4,'0'); }
    function parseDMYTime(s){
      if(!s) return null;
      const [datePart, timePart] = s.split(' ');
      const [d,m,y] = datePart.split('/').map(Number);
      let hh=0, mm=0, ss=0;
      if(timePart){
        [hh,mm,ss] = timePart.split(':').map(x=>Number(x));
      }
      return new Date(y, m-1, d, hh, mm, ss);
    }
    function formatDMYTime(dt){
      if(!dt) return '';
      const d = String(dt.getDate()).padStart(2,'0');
      const m = String(dt.getMonth()+1).padStart(2,'0');
      const y = String(dt.getFullYear());
      const hh = String(dt.getHours()).padStart(2,'0');
      const mm = String(dt.getMinutes()).padStart(2,'0');
      const ss = String(dt.getSeconds()).padStart(2,'0');
      return `${d}/${m}/${y} ${hh}:${mm}:${ss}`;
    }
    function formatTempoFromSeconds(totalSeconds){
      if(totalSeconds == null) return '';
      if(totalSeconds < 0) totalSeconds = 0;
      const hh = Math.floor(totalSeconds/3600);
      const mm = Math.floor((totalSeconds%3600)/60);
      const ss = Math.floor(totalSeconds%60);
      return `${String(hh).padStart(2,'0')}:${String(mm).padStart(2,'0')}:${String(ss).padStart(2,'0')}`;
    }

    // Last5
    function pushLast(num){
      let arr = JSON.parse(localStorage.getItem('last10')||'[]');
      arr = arr.filter(x=>x!==num);
      arr.unshift(num);
      arr = arr.slice(0,10);
      localStorage.setItem('last10', JSON.stringify(arr));
    }
    function renderLast5(){
      const last5El = document.querySelector('.last5');
      last5El.innerHTML = '';
      const arr = JSON.parse(localStorage.getItem('last10')||'[]');
      arr.forEach(x=>{
        const el = document.createElement('div');
        el.className = 'pill';
        el.textContent = x;
        el.onclick = ()=>{ numeroInput.value = x; numeroInput.focus(); };
        last5El.appendChild(el);
      });
    }
    renderLast5();

    // Focus management (only on Entrada page)
    let focusInterval = null;
    function enableEntradaFocus(){
      numeroInput.focus();
      if(focusInterval) clearInterval(focusInterval);
      focusInterval = setInterval(()=>{ if(document.activeElement !== numeroInput) numeroInput.focus(); }, 900);
    }
    function disableEntradaFocus(){
      if(focusInterval) { clearInterval(focusInterval); focusInterval = null; }
    }

    // Auth handlers
    btnLogin.onclick = async () => {
      try{
        await signInWithEmailAndPassword(auth, emailInput.value, passInput.value);
      }catch(err){
        const authError = document.getElementById('auth-error');
        authError.style.display='block';
        authError.textContent = 'Erro login: ' + err.message;
        console.error(err);
      }
    };
    btnRegister.onclick = async () => {
      try{
        await createUserWithEmailAndPassword(auth, emailInput.value, passInput.value);
        alert('Conta criada. Faça login.');
      }catch(err){
        const authError = document.getElementById('auth-error');
        authError.style.display='block';
        authError.textContent = 'Erro criar conta: ' + err.message;
        console.error(err);
      }
    };
    btnLogout.onclick = async ()=>{ await signOut(auth); };

    onAuthStateChanged(auth, user => {
      if(user){
        authCard.classList.add('hidden');
        appCard.classList.remove('hidden');
        userArea.textContent = user.email;
        startRealtimeListeners();
        showPage('entrada');
      } else {
        authCard.classList.remove('hidden');
        appCard.classList.add('hidden');
        userArea.textContent = '';
        window.location.reload();
      }
    });

    // Navigation
    navEntrada.onclick = ()=> showPage('entrada');
    navListagem.onclick = ()=> showPage('listagem');
    navLargadas.onclick = ()=> showPage('largadas');
    navResultados.onclick = ()=> showPage('resultados');

    function showPage(p){
      pageEntrada.classList.add('hidden');
      pageListagem.classList.add('hidden');
      pageLargadas.classList.add('hidden');
      pageResultados.classList.add('hidden');
      disableEntradaFocus();
      if(p==='entrada'){ pageEntrada.classList.remove('hidden'); enableEntradaFocus(); }
      if(p==='listagem') pageListagem.classList.remove('hidden');
      if(p==='largadas') pageLargadas.classList.remove('hidden');
      if(p==='resultados') pageResultados.classList.remove('hidden');
    }

    // Enter registers arrival
    numeroInput.addEventListener('keydown', (e) => {
      if(e.key === 'Enter'){
        e.preventDefault();
        registrarChegada();
      }
    });
    btnLimpar.addEventListener('click', ()=>{ numeroInput.value = ''; numeroInput.focus(); });

    async function registrarChegada(){
      const raw = (numeroInput.value || '').trim();
      if(!raw){ numeroInput.focus(); return; }
      const numero = padNum(raw.replace(/\D/g,''));
      try{
        const athleteSnap = await get(child(ref(db), `listagem/${numero}`));
        if(!athleteSnap.exists()){
          if(!confirm(`Atleta ${numero} não encontrado. Deseja cadastrar rapidamente?`)) {
            numeroInput.value=''; numeroInput.focus(); return;
          }
          await quickRegisterAthlete(numero);
        }
        const athlete = (await get(child(ref(db), `listagem/${numero}`))).val();
        let largadaInicioStr = null;
        if(athlete && athlete.modalidade){
          const largSnap = await get(child(ref(db), `largadas/${athlete.modalidade}/inicio`));
          if(largSnap.exists()) largadaInicioStr = largSnap.val();
        }
        const chegadaDt = new Date();
        const chegadaStr = formatDMYTime(chegadaDt);
        let tempoStr = null;
        if(largadaInicioStr){
          const largDt = parseDMYTime(largadaInicioStr);
          const diffSec = Math.round((chegadaDt.getTime() - largDt.getTime())/1000);
          tempoStr = formatTempoFromSeconds(diffSec);
        }
        await set(ref(db, `resultados/${numero}`), {
          chegada: chegadaStr,
          tempo: tempoStr || '',
          atleta: (athlete && athlete.atleta) || '',
          genero: (athlete && athlete.genero) || '',
          modalidade: (athlete && athlete.modalidade) || '',
          categoria: (athlete && athlete.categoria) || '',
          data_nascimento: (athlete && athlete.data_nascimento) || '',
          idade: (athlete && athlete.idade) || '',
          registradoPor: auth.currentUser ? auth.currentUser.email : null,
          registradaEmISO: new Date().toISOString()
        });
        pushLast(numero);
        renderLast5();
        numeroInput.value = '';
        numeroInput.focus();
      }catch(err){
        console.error('Erro registrar chegada:', err);
        alert('Erro ao registrar chegada: ' + (err.message||err));
      }
    }

    // Quick register modal
    async function quickRegisterAthlete(numero){
      return new Promise((resolve, reject)=>{
        const overlay = document.createElement('div'); overlay.className='overlay';
        const form = document.createElement('form'); form.className='modal';
        form.innerHTML = `
          <h4>Cadastro Rápido - ${numero}</h4>
          <input id="q_atleta" placeholder="Nome (Atleta)" required />
          <input id="q_genero" placeholder="Gênero (ex: Feminino)" />
          <input id="q_modalidade" placeholder="Modalidade (ex: MTB)" />
          <input id="q_categoria" placeholder="Categoria" />
          <input id="q_data_nasc" placeholder="Data Nascimento (DD/MM/YYYY)" />
          <input id="q_idade" placeholder="Idade" type="number" />
          <div class="form-actions">
            <button type="button" id="q_cancel" class="ghost">Cancelar</button>
            <button type="submit">Salvar</button>
          </div>
        `;
        document.body.appendChild(overlay); document.body.appendChild(form);
        form.q_atleta.focus();
        form.q_cancel.onclick = ()=>{ form.remove(); overlay.remove(); resolve(); };
        form.onsubmit = async (e)=>{
          e.preventDefault();
          try{
            await set(ref(db, `listagem/${numero}`), {
              atleta: form.q_atleta.value,
              genero: form.q_genero.value,
              modalidade: form.q_modalidade.value,
              categoria: form.q_categoria.value,
              data_nascimento: form.q_data_nasc.value,
              idade: form.q_idade.value
            });
            form.remove(); overlay.remove(); resolve();
          }catch(err){ form.remove(); overlay.remove(); reject(err); }
        };
      });
    }

    // CSV upload (listagem)
    csvUpload.addEventListener('change', (e)=>{
      const file = e.target.files[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = async () => {
        const text = reader.result;
        const lines = text.split(/\r?\n/).filter(Boolean);
        let start = 0;
        if(lines.length>0){
          const firstCols = lines[0].split(',');
          if(isNaN(Number(firstCols[0].replace(/\D/g,'')))) start = 1;
        }
        try{
          for(let i=start; i<lines.length; i++){
            const cols = lines[i].split(',').map(c=>c.trim());
            if(cols.length < 2) continue;
            const rawNumero = cols[0].replace(/\D/g,'');
            if(!rawNumero) continue;
            const numero = padNum(rawNumero);
            const data = {
              atleta: cols[1] || '',
              genero: cols[2] || '',
              modalidade: cols[3] || '',
              categoria: cols[4] || '',
              data_nascimento: cols[5] || '',
              idade: cols[6] || ''
            };
            await set(ref(db, `listagem/${numero}`), data);
          }
          alert('CSV importado com sucesso!');
          csvUpload.value = '';
        }catch(err){
          console.error('Erro importar CSV', err);
          alert('Erro ao importar CSV: ' + (err.message||err));
        }
      };
      reader.readAsText(file, 'utf-8');
    });

    // New athlete modal
    btnAddAthlete.onclick = ()=>{
      const overlay = document.createElement('div'); overlay.className='overlay';
      const form = document.createElement('form'); form.className='modal';
      form.innerHTML = `
        <h4>Novo Atleta</h4>
        <input id="a_numero" placeholder="Número (ex: 1 ou 0001)" required />
        <input id="a_nome" placeholder="Nome" required />
        <input id="a_genero" placeholder="Gênero" />
        <input id="a_modalidade" placeholder="Modalidade" />
        <input id="a_categoria" placeholder="Categoria" />
        <input id="a_data_nasc" placeholder="Data Nascimento (DD/MM/YYYY)" />
        <input id="a_idade" placeholder="Idade" type="number" />
        <div class="form-actions">
          <button type="button" id="a_cancel" class="ghost">Cancelar</button>
          <button type="submit">Salvar</button>
        </div>
      `;
      document.body.appendChild(overlay); document.body.appendChild(form);
      form.a_numero.focus();
      form.a_cancel.onclick = ()=>{ form.remove(); overlay.remove(); };
      form.onsubmit = async (e)=>{
        e.preventDefault();
        const raw = form.a_numero.value.replace(/\D/g,'');
        if(!raw){ alert('Número inválido'); return; }
        const numero = padNum(raw);
        try{
          await set(ref(db, `listagem/${numero}`), {
            atleta: form.a_nome.value,
            genero: form.a_genero.value,
            modalidade: form.a_modalidade.value,
            categoria: form.a_categoria.value,
            data_nascimento: form.a_data_nasc.value,
            idade: form.a_idade.value
          });
          form.remove(); overlay.remove();
        }catch(err){ console.error(err); alert('Erro ao salvar: '+(err.message||err)); }
      };
    };

    // New largada modal
    btnAddLargada.onclick = ()=>{
      const overlay = document.createElement('div'); overlay.className='overlay';
      const form = document.createElement('form'); form.className='modal';
      form.innerHTML = `
        <h4>Nova Largada</h4>
        <input id="l_modalidade" placeholder="Modalidade (ex: MTB)" required />
        <label class="small">Início (DD/MM/YYYY HH:MM:SS)</label>
        <input id="l_inicio" placeholder="22/10/2025 08:00:00" required />
        <div class="form-actions">
          <button type="button" id="l_cancel" class="ghost">Cancelar</button>
          <button type="submit">Salvar</button>
        </div>
      `;
      document.body.appendChild(overlay); document.body.appendChild(form);
      form.l_modalidade.focus();
      form.l_cancel.onclick = ()=>{ form.remove(); overlay.remove(); };
      form.onsubmit = async (e)=>{
        e.preventDefault();
        const modalidade = form.l_modalidade.value.trim();
        const inicioStr = form.l_inicio.value.trim();
        if(!modalidade || !inicioStr){ alert('Preencha todos os campos'); return; }
        try{
          await set(ref(db, `largadas/${modalidade}/inicio`), inicioStr);
          form.remove(); overlay.remove();
        }catch(err){ console.error(err); alert('Erro ao salvar largada: '+(err.message||err)); }
      };
    };

    // Real-time listeners and state
    let latestListagem = [];
    let latestLargadas = [];
    let latestResultados = [];
    let filteredResultadosCache = [];

    function startRealtimeListeners(){
      onValue(ref(db, 'listagem'), (snap)=>{
        const data = snap.val() || {};
        latestListagem = Object.keys(data).map(k => Object.assign({numero: k}, data[k]));
        renderListagem(latestListagem);
        rebuildResultFilters();
      }, (err)=>{ console.error('Erro listener listagem:', err); });

      onValue(ref(db, 'largadas'), (snap)=>{
        const data = snap.val() || {};
        latestLargadas = Object.keys(data).map(k => ({modalidade: k, inicio: data[k].inicio || ''}));
        renderLargadas(latestLargadas);
        rebuildResultFilters();
      }, (err)=>{ console.error('Erro listener largadas:', err); });

      onValue(ref(db, 'resultados'), (snap)=>{
        const data = snap.val() || {};
        latestResultados = Object.keys(data).map(k => Object.assign({numero: k}, data[k]));
        latestResultados.sort((a,b)=>{
          const da = a.registradaEmISO ? new Date(a.registradaEmISO) : (a.chegada ? parseDMYTime(a.chegada) : new Date(0));
          const dbb = b.registradaEmISO ? new Date(b.registradaEmISO) : (b.chegada ? parseDMYTime(b.chegada) : new Date(0));
          return dbb - da;
        });
        renderResultados(latestResultados);
      }, (err)=>{ console.error('Erro listener resultados:', err); });
    }

    function renderListagem(rows){
      const q = (searchListagem.value || '').trim().toLowerCase();
      const filtered = rows.filter(r => !q || (r.numero && r.numero.toLowerCase().includes(q)) || (r.atleta && r.atleta.toLowerCase().includes(q)));
      let html = `<table><thead><tr><th>Número</th><th>Nome</th><th>Gênero</th><th>Modalidade</th><th>Categoria</th><th>Idade</th><th>Ações</th></tr></thead><tbody>`;
      filtered.forEach(r=>{
        html += `<tr>
          <td>${r.numero}</td>
          <td>${escapeHtml(r.atleta||'')}</td>
          <td>${escapeHtml(r.genero||'')}</td>
          <td>${escapeHtml(r.modalidade||'')}</td>
          <td>${escapeHtml(r.categoria||'')}</td>
          <td>${escapeHtml(r.idade||'')}</td>
          <td>
            <button data-num="${r.numero}" class="btn-edit">Editar</button>
            <button data-num="${r.numero}" class="btn-delete ghost">Apagar</button>
          </td>
        </tr>`;
      });
      html += `</tbody></table>`;
      tableListagem.innerHTML = html;
      tableListagem.querySelectorAll('.btn-edit').forEach(btn=> btn.onclick = ()=> openEditAthlete(btn.dataset.num) );
      tableListagem.querySelectorAll('.btn-delete').forEach(btn=> btn.onclick = async ()=>{ if(!confirm(`Apagar atleta ${btn.dataset.num}?`)) return; try{ await remove(ref(db, `listagem/${btn.dataset.num}`)); alert('Apagado'); }catch(err){ console.error(err); alert('Erro: '+(err.message||err)); } });
    }

    function openEditAthlete(numero){
      get(child(ref(db), `listagem/${numero}`)).then(snap=>{
        const data = snap.exists() ? snap.val() : {};
        const overlay = document.createElement('div'); overlay.className='overlay';
        const form = document.createElement('form'); form.className='modal';
        form.innerHTML = `
          <h4>Editar Atleta - ${numero}</h4>
          <input id="e_nome" placeholder="Nome" value="${escapeAttr(data.atleta||'')}" />
          <input id="e_genero" placeholder="Gênero" value="${escapeAttr(data.genero||'')}" />
          <input id="e_modalidade" placeholder="Modalidade" value="${escapeAttr(data.modalidade||'')}" />
          <input id="e_categoria" placeholder="Categoria" value="${escapeAttr(data.categoria||'')}" />
          <input id="e_data_nasc" placeholder="Data Nascimento (DD/MM/YYYY)" value="${escapeAttr(data.data_nascimento||'')}" />
          <input id="e_idade" placeholder="Idade" type="number" value="${escapeAttr(data.idade||'')}" />
          <div class="form-actions">
            <button type="button" id="e_cancel" class="ghost">Cancelar</button>
            <button type="submit">Salvar</button>
          </div>
        `;
        document.body.appendChild(overlay); document.body.appendChild(form);
        form.e_cancel.onclick = ()=>{ form.remove(); overlay.remove(); };
        form.onsubmit = async (e)=>{
          e.preventDefault();
          try{
            await update(ref(db, `listagem/${numero}`), {
              atleta: form.e_nome.value,
              genero: form.e_genero.value,
              modalidade: form.e_modalidade.value,
              categoria: form.e_categoria.value,
              data_nascimento: form.e_data_nasc.value,
              idade: form.e_idade.value
            });
            form.remove(); overlay.remove();
          }catch(err){ console.error(err); alert('Erro salvar: '+(err.message||err)); }
        };
      });
    }

    function renderLargadas(rows){
      let html = `<table><thead><tr><th>Modalidade</th><th>Início</th><th>Ações</th></tr></thead><tbody>`;
      rows.forEach(r=>{
        html += `<tr>
          <td>${escapeHtml(r.modalidade||'')}</td>
          <td>${escapeHtml(r.inicio||'')}</td>
          <td>
            <button data-mod="${r.modalidade}" class="btn-edit-l">Editar</button>
            <button data-mod="${r.modalidade}" class="btn-del-l ghost">Apagar</button>
          </td>
        </tr>`;
      });
      html += `</tbody></table>`;
      tableLargadas.innerHTML = html;
      tableLargadas.querySelectorAll('.btn-edit-l').forEach(btn=> btn.onclick = ()=> openEditLargada(btn.dataset.mod) );
      tableLargadas.querySelectorAll('.btn-del-l').forEach(btn=> btn.onclick = async ()=>{ if(!confirm(`Apagar largada ${btn.dataset.mod}?`)) return; try{ await remove(ref(db, `largadas/${btn.dataset.mod}`)); alert('Apagado'); }catch(err){ console.error(err); alert('Erro: '+(err.message||err)); } });
    }

    function openEditLargada(modalidade){
      get(child(ref(db), `largadas/${modalidade}/inicio`)).then(snap=>{
        const inicio = snap.exists() ? snap.val() : '';
        const overlay = document.createElement('div'); overlay.className='overlay';
        const form = document.createElement('form'); form.className='modal';
        form.innerHTML = `
          <h4>Editar Largada - ${modalidade}</h4>
          <label class="small">Início (DD/MM/YYYY HH:MM:SS)</label>
          <input id="el_inicio" value="${escapeAttr(inicio||'')}" />
          <div class="form-actions">
            <button type="button" id="el_cancel" class="ghost">Cancelar</button>
            <button type="submit">Salvar</button>
          </div>
        `;
        document.body.appendChild(overlay); document.body.appendChild(form);
        form.el_cancel.onclick = ()=>{ form.remove(); overlay.remove(); };
        form.onsubmit = async (e)=>{
          e.preventDefault();
          try{
            await set(ref(db, `largadas/${modalidade}/inicio`), form.el_inicio.value);
            form.remove(); overlay.remove();
          }catch(err){ console.error(err); alert('Erro salvar: '+(err.message||err)); }
        };
      });
    }

    function rebuildResultFilters(){
      const modalidades = new Set();
      latestListagem.forEach(r=>{ if(r.modalidade) modalidades.add(r.modalidade); });
      latestLargadas.forEach(r=>{ if(r.modalidade) modalidades.add(r.modalidade); });
      const categorias = new Set();
      latestListagem.forEach(r=>{ if(r.categoria) categorias.add(r.categoria); });
      latestResultados.forEach(r=>{ if(r.categoria) categorias.add(r.categoria); });
      const generos = new Set();
      latestListagem.forEach(r=>{ if(r.genero) generos.add(r.genero); });
      latestResultados.forEach(r=>{ if(r.genero) generos.add(r.genero); });

      fillSelect(fModalidade, [...modalidades].sort(), 'Todas');
      fillSelect(fCategoria, [...categorias].sort(), 'Todas');
      fillSelect(fGenero, [...generos].sort(), 'Todos');
    }
    function fillSelect(selectEl, arr, firstLabel){
      selectEl.innerHTML = `<option value="">${firstLabel||'Todos'}</option>`;
      arr.forEach(x=>{ const o=document.createElement('option'); o.value=x; o.textContent=x; selectEl.appendChild(o); });
    }

    btnAplicarFiltro.onclick = ()=> renderResultados(latestResultados);

    function renderResultados(rows){
  const fm = fModalidade.value;
  const fc = fCategoria.value;
  const fg = fGenero.value;
  const filtered = rows.filter(r=>{
    if(fm && r.modalidade !== fm) return false;
    if(fc && r.categoria !== fc) return false;
    if(fg && r.genero !== fg) return false;
    return true;
  });

  // Ordena por tempo (ascendente)
  filtered.sort((a,b)=>{
    if(!a.tempo) return 1;
    if(!b.tempo) return -1;
    const [ah,am,as] = a.tempo.split(':').map(Number);
    const [bh,bm,bs] = b.tempo.split(':').map(Number);
    const ta = ah*3600 + am*60 + as;
    const tb = bh*3600 + bm*60 + bs;
    return ta - tb;
  });

  filteredResultadosCache = filtered;

  let html = `<table><thead><tr>
    <th>Posição</th>
    <th>Número</th>
    <th>Atleta</th>
    <th>Modalidade</th>
    <th>Categoria</th>
    <th>Gênero</th>
    <th>Chegada</th>
    <th>Tempo</th>
    <th>Ações</th>
  </tr></thead><tbody>`;

  filtered.forEach((r, i)=>{
    const pos = `${i+1}º`;
    html += `<tr>
      <td><strong>${pos}</strong></td>
      <td>${r.numero}</td>
      <td>${escapeHtml(r.atleta||'')}</td>
      <td>${escapeHtml(r.modalidade||'')}</td>
      <td>${escapeHtml(r.categoria||'')}</td>
      <td>${escapeHtml(r.genero||'')}</td>
      <td>${escapeHtml(r.chegada||'')}</td>
      <td>${escapeHtml(r.tempo||'')}</td>
      <td><button data-num="${r.numero}" class="btn-edit-res">Editar</button></td>
    </tr>`;
  });

  html += `</tbody></table>`;
  tableResultados.innerHTML = html;
  tableResultados.querySelectorAll('.btn-edit-res').forEach(btn=> btn.onclick = ()=> openEditResultado(btn.dataset.num) );
}

    function openEditResultado(numero){
      get(child(ref(db), `resultados/${numero}`)).then(async snap=>{
        const data = snap.exists() ? snap.val() : {};
        const athleteSnap = await get(child(ref(db), `listagem/${numero}`));
        const athlete = athleteSnap.exists() ? athleteSnap.val() : {};
        const overlay = document.createElement('div'); overlay.className='overlay';
        const form = document.createElement('form'); form.className='modal';
        form.innerHTML = `
          <h4>Editar Resultado - ${numero}</h4>
          <input id="r_nome" placeholder="Nome" value="${escapeAttr(data.atleta || athlete.atleta || '')}" />
          <input id="r_modalidade" placeholder="Modalidade" value="${escapeAttr(data.modalidade || athlete.modalidade || '')}" />
          <input id="r_categoria" placeholder="Categoria" value="${escapeAttr(data.categoria || athlete.categoria || '')}" />
          <input id="r_genero" placeholder="Gênero" value="${escapeAttr(data.genero || athlete.genero || '')}" />
          <label class="small">Chegada (DD/MM/YYYY HH:MM:SS)</label>
          <input id="r_chegada" value="${escapeAttr(data.chegada||'')}" />
          <label class="small">Tempo (HH:MM:SS)</label>
          <input id="r_tempo" value="${escapeAttr(data.tempo||'')}" />
          <div class="form-actions">
            <button type="button" id="r_cancel" class="ghost">Cancelar</button>
            <button type="submit">Salvar</button>
          </div>
        `;
        document.body.appendChild(overlay); document.body.appendChild(form);
        form.r_cancel.onclick = ()=>{ form.remove(); overlay.remove(); };
        form.onsubmit = async (e)=>{
          e.preventDefault();
          try{
            await update(ref(db, `resultados/${numero}`), {
              atleta: form.r_nome.value,
              modalidade: form.r_modalidade.value,
              categoria: form.r_categoria.value,
              genero: form.r_genero.value,
              chegada: form.r_chegada.value,
              tempo: form.r_tempo.value,
              registradaEmISO: new Date().toISOString()
            });
            await update(ref(db, `listagem/${numero}`), {
              atleta: form.r_nome.value,
              modalidade: form.r_modalidade.value,
              categoria: form.r_categoria.value,
              genero: form.r_genero.value
            });
            form.remove(); overlay.remove();
          }catch(err){ console.error(err); alert('Erro ao salvar: '+(err.message||err)); }
        };
      });
    }

    // Export CSV
    btnExport.onclick = ()=>{
      const rows = filteredResultadosCache.length ? filteredResultadosCache : latestResultados;
      if(!rows || !rows.length){ alert('Nenhum resultado para exportar'); return; }
      const header = ['numero','atleta','modalidade','categoria','genero','chegada','tempo'];
      const csv = [header.join(',')].concat(rows.map(r=> header.map(h=> `"${String(r[h]||'').replace(/"/g,'""')}"`).join(','))).join('\n');
      const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'resultados_export.csv';
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    };

    // search handler and utils
    searchListagem.addEventListener('input', ()=> renderListagem(latestListagem) );

    function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, (m)=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
    function escapeAttr(s){ return escapeHtml(s).replace(/"/g,'&quot;'); }

    // initial UI
    showPage('entrada');

  </script>
</body>
</html>
