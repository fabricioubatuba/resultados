<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Resultados</title>
<!-- Favicon (√≠cone na aba do navegador) -->
    <link rel="icon" href="assets/img/favicon.ico" type="image/x-icon">
  <style>
    :root{--accent:#1e90ff;--accent-2:#ff8a00;font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial}
    body{margin:0;background:#f6f8fb;color:#111;font-family:var(--font, Inter), sans-serif}
    header{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#fff;padding:12px 18px;display:flex;align-items:center;justify-content:space-between}
    .brand{font-weight:700}
    .container{max-width:1100px;margin:20px auto;padding:12px}
    .card{background:#fff;border-radius:10px;padding:16px;box-shadow:0 6px 18px rgba(20,30,60,0.06);}
    .big-input{font-size:72px;letter-spacing:10px;padding:28px 20px;text-align:center;width:720px;box-sizing:border-box;border-radius:8px;border:1px solid #ddd}
    .row{display:flex;gap:12px;align-items:center}
    button{background:var(--accent);color:#fff;border:none;padding:10px 14px;border-radius:8px;cursor:pointer}
    button.secondary{background:#e6eefc;color:#1e3a8a}
    .ghost{background:transparent;border:1px solid #ddd;color:#333}
    nav{
      display: flex;
      gap: 8px;
      margin-top: 24px;
      flex-basis: 100%;
      justify-content: flex-start;
    }
    table{width:100%;border-collapse:collapse}
    th,td{padding:6px 8px;border-bottom:1px solid #f0f0f0;text-align:left}
    .small{font-size:13px;color:#666}
    .last5{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .pill{background:#f1f5f9;padding:6px 10px;border-radius:999px;font-weight:600;cursor:pointer}
    .hidden{display:none}
    .filters{display:flex;gap:8px;align-items:center}
    form.modal{background:#fff;border:1px solid #ccc;border-radius:10px;padding:16px;box-shadow:0 8px 30px rgba(0,0,0,0.18);position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:60;min-width:320px}
    form.modal input, form.modal select{width:100%;padding:8px;margin:6px 0;border:1px solid #ccc;border-radius:6px;box-sizing:border-box}
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,0.35);z-index:50}
    .form-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:8px}
    .error{color:#b00020}
    .disabled{opacity:0.6;pointer-events:none}
    .success{color:#00c853}
    .warning{color:#ff6d00}

    /* Estilos para os comprovantes */
    .comprovante-container { position: relative; width: 100%; margin: 20px 0; }
    .comprovante-story { width: 270px; height: 480px; position: relative; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; overflow: hidden; color: white; font-family: 'Arial', sans-serif; }
    .comprovante-feed { width: 400px; height: 400px; position: relative; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; overflow: hidden; color: white; font-family: 'Arial', sans-serif; }
    .comprovante-bg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-size: cover; opacity: 0.3; }
    .comprovante-content { position: relative; z-index: 2; padding: 20px; height: 100%; display: flex; flex-direction: column; justify-content: space-between; }
    .comprovante-header { text-align: center; margin-bottom: 20px; }
    .comprovante-title { font-size: 24px; font-weight: bold; margin-bottom: 8px; }
    .comprovante-subtitle { font-size: 14px; opacity: 0.9; }
    .comprovante-data { flex-grow: 1; display: flex; flex-direction: column; justify-content: center; gap: 10px; font-size: 13px; }
    .comprovante-item {  display: flex; justify-content: space-between;  border-bottom: 1px solid rgba(255,255,255,0.2);  padding: 8px 0; }
/* Adicione esta nova regra para centralizar apenas a data */
    .comprovante-item-centralizado {  display: flex;  justify-content: center;  border-bottom: 1px solid rgba(255,255,255,0.2);  padding: 8px 0;  text-align: center; }
    .comprovante-item-label { font-weight: bold; }
    .comprovante-footer { text-align: center; margin-top: 20px; }
    .comprovante-logo { position: absolute; bottom: 50px; right: 10px; width: 40px; height: 40px; background: white; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 12px; }
    .comprovante-formatos { display: flex; gap: 10px; margin: 15px 0; }
    .comprovante-formatos button { flex: 1; }

    /* Estilo para a logo RC4 Sports */
    .logo-rc4 {
      height: 65px;
      width: auto;
      max-width: 140px;
      object-fit: contain;
      margin-left: 15px;
    }

        /* Imagens de fundo para os comprovantes */
    .comprovante-story {
      background: url('https://lh3.googleusercontent.com/d/1pJrOTAbzY_3uTJZQKgKI72ATN3x3LoiR') center/cover no-repeat;
    }
    .comprovante-feed {
      background: url('https://lh3.googleusercontent.com/d/1C4D7YRq2hEYLzq91o28aZa16kgO8figs') center/cover no-repeat;
    }
    
    /* Ajustes para melhor legibilidade sobre as imagens */
    .comprovante-content {
      background: rgba(0, 0, 0, 0.6); /* Fundo escuro semi-transparente para melhor contraste */
      position: relative;
      z-index: 2;
      padding: 20px;
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      border-radius: 12px;
    }
    
    /* Remover o comprovante-bg anterior j√° que usamos background direto */
    .comprovante-bg {
      display: none;
    }

    @media(max-width:900px){ 
      .big-input{width:100%;font-size:48px;padding:16px} 
      .container{padding:8px} 
      nav{flex-wrap:wrap} 
      .comprovante-story, .comprovante-feed { 
        width: 100%; 
        max-width: 300px; 
        margin: 0 auto; 
      }
      .logo-rc4 {
        height: 40px;
        max-width: 100px;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="brand">4 HORAS DE MTB E TRAIL RUN MATA ATL√ÇNTICA</div>
    <div id="user-area" class="small"></div>
  </header>

  <div class="container">
    <!-- Auth -->
    <div class="card" id="auth-card">
      <h3>Entrar</h3>
      <div style="display:flex;gap:8px;align-items:center;margin-top:8px;flex-wrap:wrap">
        <input id="email" placeholder="email" style="padding:8px;border-radius:6px;border:1px solid #ddd" />
        <input id="password" placeholder="senha" type="password" style="padding:8px;border-radius:6px;border:1px solid #ddd" />
        <button id="btn-login">Entrar</button>
        <button id="btn-register" class="secondary">Criar conta</button>
        <button id="btn-visitante" class="ghost">Entrar como Visitante</button>
      </div>
      <p class="small">Autentica√ß√£o via Firebase (Email/Senha). Fa√ßa login para acessar o painel. Ou entre como visitante para somente leitura nos resultados.</p>
      <p class="small error" id="auth-error" style="display:none"></p>
    </div>

    <!-- App -->
    <div class="card hidden" id="app-card">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
        <div style="flex:1;min-width:280px">
          <div style="font-size:14px;color:#444">Entrada r√°pida de n√∫mero (foco autom√°tico) ‚Äî apenas pressione <strong>Enter</strong></div>
          <div style="margin-top:8px;display:flex;align-items:center;gap:12px;flex-wrap:wrap">
            <input id="numero-input" maxlength="10" class="big-input" placeholder="0000" autocomplete="off" inputmode="numeric" />
            <div style="display:flex;flex-direction:row;gap:8px;align-items:center;margin-left:20px">
              <button id="btn-limpar" class="ghost">Limpar</button>
              <img src="https://www.rc4sports.com.br/assets/img/Logo-RC4-Sports.png" alt="RC4 Sports" class="logo-rc4">
            </div>
          </div>
          <div style="display:flex;align-items:center;gap:8px;margin-top:8px;flex-wrap:wrap">
  <div class="small">√öltimos 10 atletas registrados (compartilhado)</div>
  <button id="btn-limpar-ultimos" class="ghost">Limpar</button>
</div>
<div class="last5" id="last5"></div>

        </div>

        <nav id="main-nav">
          <button id="nav-entrada" class="secondary">Registrar Chegada</button>
          <button id="nav-voltas-mtb" class="secondary">Voltas MTB</button>
          <button id="nav-voltas-duathlon" class="secondary">Voltas Duathlon</button>
          <button id="nav-listagem" class="secondary">Listagem Completa</button>
          <button id="nav-largadas" class="secondary">Largadas</button>
          <button id="nav-resultados" class="secondary">Resultados</button>
          <button id="btn-logout" class="ghost">Sair</button>
        </nav>
      </div>

      <hr style="margin:12px 0" />

      <div id="pages">
        <!-- ENTRADA -->
        <div id="page-entrada">
          <div style="margin-top:12px">
            <p class="small">Aponte o leitor de c√≥digo de barras e pressione Enter. O cursor permanecer√° aqui enquanto estiver nesta tela.</p>
            <p class="small success" id="entrada-success" style="display:none"></p>
            <p class="small error" id="entrada-error" style="display:none"></p>
            <p class="small warning" id="entrada-warning" style="display:none"></p>
          </div>
        </div>

        <!-- VOLTAS MTB -->
        <div id="page-voltas-mtb" class="hidden">
          <h4>Registro de Voltas - MTB</h4>
          <div style="margin-bottom:16px">
            <p class="small">Visualize as voltas registradas dos atletas de MTB. Cada registro conta 1 volta. O sistema calcula automaticamente a classifica√ß√£o baseada em maior n√∫mero de voltas e menor tempo.</p>
            <p class="small warning">‚ö†Ô∏è Intervalo m√≠nimo entre voltas: 3 minutos</p>
          </div>
          
          <!-- Filtro para voltas MTB -->
          <div style="display:flex;gap:8px;align-items:center;margin-bottom:12px;flex-wrap:wrap">
            <input id="filtro-voltas-numero" placeholder="Filtrar por n√∫mero do atleta" style="padding:8px;border-radius:6px;border:1px solid #ddd;width:200px" />
            <button id="btn-limpar-filtro-voltas" class="ghost">Limpar Filtro</button>
	    <button id="btn-limpar-voltas" class="secondary">Limpar Registro de Voltas</button>

          </div>
          
          <div id="table-voltas-mtb"></div>
        </div>

        <!-- VOLTAS DUATHLON -->
        <div id="page-voltas-duathlon" class="hidden">
          <h4>Registro de Voltas - Duathlon Cross</h4>
          <div style="margin-bottom:16px">
            <p class="small">Visualize as voltas registradas dos atletas de Duathlon Cross. Cada registro conta 1 volta. O sistema calcula automaticamente a classifica√ß√£o baseada em maior n√∫mero de voltas e menor tempo.</p>
            <p class="small warning">‚ö†Ô∏è Intervalo m√≠nimo entre voltas: 3 minutos</p>
          </div>
          
          <!-- Filtro para voltas Duathlon -->
          <div style="display:flex;gap:8px;align-items:center;margin-bottom:12px;flex-wrap:wrap">
            <input id="filtro-voltas-duathlon-numero" placeholder="Filtrar por n√∫mero do atleta" style="padding:8px;border-radius:6px;border:1px solid #ddd;width:200px" />
            <button id="btn-limpar-filtro-voltas-duathlon" class="ghost">Limpar Filtro</button>
	    <button id="btn-limpar-voltas-duathlon" class="secondary">Limpar Registro de Voltas</button>
          </div>
          
          <div id="table-voltas-duathlon"></div>
        </div>

        <!-- LISTAGEM -->
        <div id="page-listagem" class="hidden">
          <h4>Listagem Completa</h4>
          <div class="row" style="margin:8px 0;align-items:center">
            <button id="btn-add-athlete" class="secondary">Novo Atleta</button>
	    <button id="btn-limpar-listagem" class="secondary">Limpar Lista de Atletas</button>

            <input type="file" id="csv-upload" accept=".csv" />
            <input id="search-listagem" placeholder="Pesquisar por nome ou n√∫mero" style="flex:1;padding:8px;border-radius:6px;border:1px solid #ddd" />
          </div>
          <div id="table-listagem"></div>
        </div>

        <!-- LARGADAS -->
        <div id="page-largadas" class="hidden">
          <h4>Largadas</h4>
          <div style="display:flex;gap:8px;margin-bottom:8px;align-items:center">
            <button id="btn-add-largada" class="secondary">Nova Largada</button>
          </div>
          <div id="table-largadas"></div>
        </div>

        <!-- RESULTADOS -->
        <div id="page-resultados" class="hidden">
          <h4>Resultados</h4>
          <div style="display:flex;gap:8px;align-items:center;margin-bottom:12px;flex-wrap:wrap">
            <div class="filters" style="align-items:center">
              <label class="small">Modalidade</label>
              <select id="f-modalidade"><option value="">Todas</option></select>
              <label class="small">Categoria</label>
              <select id="f-categoria"><option value="">Todas</option></select>
              <label class="small">G√™nero</label>
              <select id="f-genero"><option value="">Todos</option></select>
              <button id="btn-aplicar-filtro" class="secondary">Aplicar</button>
            </div>
            <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
              <button id="btn-export" class="secondary">Exportar CSV</button>
	      <button id="btn-imprimir-resultados" class="secondary">Imprimir Resultados</button>
              <button id="btn-comprovante" class="secondary">Gerar Comprovante</button>
	      <button id="btn-limpar-resultados" class="secondary">Limpar Resultados</button>
            </div>
          </div>
          <div id="table-resultados"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal para Gerar Comprovante -->
  <div id="modal-comprovante" class="hidden" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1000; display: none; align-items: center; justify-content: center;">
    <div class="overlay" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5);"></div>
    <div class="modal" style="position: relative; z-index: 1001; max-width: 500px; background: white; border-radius: 10px; padding: 20px; margin: 20px;">
      <h4>Gerar Comprovante</h4>
      <div class="comprovante-formatos">
        <button id="btn-comprovante-story" class="secondary">Formato Story</button>
        <button id="btn-comprovante-feed" class="secondary">Formato Feed</button>
      </div>
      <div class="comprovante-container">
        <div id="comprovante-preview" class="comprovante-story">
          <div class="comprovante-content">
            <div class="comprovante-header">
              <div class="comprovante-title">4 HORAS MATA ATL√ÇNTICA</div>
              <div class="comprovante-subtitle">Desafio Conclu√≠do!</div>
            </div>
            <div class="comprovante-data" id="comprovante-data">
              <!-- Dados ser√£o preenchidos via JavaScript -->
            </div>
            <div class="comprovante-footer">
              <div id="comprovante-texto"></div>
            </div>
            <div class="comprovante-logo">
              <img src="https://lh3.googleusercontent.com/d/1zHFiEJj1bpUN_ghxdq07dqjvVX0aLKv0" alt="Logo" style="width: 100%; height: 100%; object-fit: contain;">
            </div>
          </div>
        </div>
      </div>
      <div class="form-actions">
        <button id="btn-fechar-comprovante" class="ghost">Fechar</button>
        <button id="btn-download-comprovante" class="secondary">Download</button>
      </div>
    </div>
  </div>
  
<script type="module">
    const firebaseConfig = {
      apiKey: "AIzaSyBZqXrKnRGvM0BG5qrrE38R8zR25tacOzw",
      authDomain: "teste-c702e.firebaseapp.com",
      databaseURL: "https://teste-c702e-default-rtdb.firebaseio.com",
      projectId: "teste-c702e",
      storageBucket: "teste-c702e.firebasestorage.app",
      messagingSenderId: "478905955045",
      appId: "1:478905955045:web:86bc4f77bf4296c6e85a0c"
    };

    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js';
    import { getDatabase, ref, set, get, onValue, child, remove, update, push } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js';

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    // UI refs
    const authCard = document.getElementById('auth-card');
    const appCard = document.getElementById('app-card');
    const userArea = document.getElementById('user-area');
    const emailInput = document.getElementById('email');
    const passInput = document.getElementById('password');
    const btnLogin = document.getElementById('btn-login');
    const btnRegister = document.getElementById('btn-register');
    const btnVisitante = document.getElementById('btn-visitante');
    const btnLogout = document.getElementById('btn-logout');
    const authError = document.getElementById('auth-error');

    const numeroInput = document.getElementById('numero-input');
    const btnLimpar = document.getElementById('btn-limpar');
    const entradaSuccess = document.getElementById('entrada-success');
    const entradaError = document.getElementById('entrada-error');
    const entradaWarning = document.getElementById('entrada-warning');

    const navEntrada = document.getElementById('nav-entrada');
    const navVoltasMtb = document.getElementById('nav-voltas-mtb');
    const navVoltasDuathlon = document.getElementById('nav-voltas-duathlon');
    const navListagem = document.getElementById('nav-listagem');
    const navLargadas = document.getElementById('nav-largadas');
    const navResultados = document.getElementById('nav-resultados');

    const pageEntrada = document.getElementById('page-entrada');
    const pageVoltasMtb = document.getElementById('page-voltas-mtb');
    const pageVoltasDuathlon = document.getElementById('page-voltas-duathlon');
    const pageListagem = document.getElementById('page-listagem');
    const pageLargadas = document.getElementById('page-largadas');
    const pageResultados = document.getElementById('page-resultados');

    const tableListagem = document.getElementById('table-listagem');
    const tableVoltasMtb = document.getElementById('table-voltas-mtb');
    const tableVoltasDuathlon = document.getElementById('table-voltas-duathlon');
    const tableLargadas = document.getElementById('table-largadas');
    const tableResultados = document.getElementById('table-resultados');

    // Elementos para filtro de voltas
    const filtroVoltasNumero = document.getElementById('filtro-voltas-numero');
    const btnLimparFiltroVoltas = document.getElementById('btn-limpar-filtro-voltas');
    const filtroVoltasDuathlonNumero = document.getElementById('filtro-voltas-duathlon-numero');
    const btnLimparFiltroVoltasDuathlon = document.getElementById('btn-limpar-filtro-voltas-duathlon');

    const btnAddAthlete = document.getElementById('btn-add-athlete');
    const csvUpload = document.getElementById('csv-upload');
    const searchListagem = document.getElementById('search-listagem');
    const btnAddLargada = document.getElementById('btn-add-largada');

    const fModalidade = document.getElementById('f-modalidade');
    const fCategoria = document.getElementById('f-categoria');
    const fGenero = document.getElementById('f-genero');
    const btnAplicarFiltro = document.getElementById('btn-aplicar-filtro');
    const btnExport = document.getElementById('btn-export');
    const btnComprovante = document.getElementById('btn-comprovante');

// Bot√£o para limpar todos os resultados registrados
const btnLimparResultados = document.getElementById('btn-limpar-resultados');
btnLimparResultados.addEventListener('click', async () => {
  if (isVisitor || !auth.currentUser) {
    alert('A√ß√£o proibida: modo visitante. Fa√ßa login para limpar resultados.');
    return;
  }
  if (!confirm('Tem certeza que deseja apagar TODOS os resultados registrados? Essa a√ß√£o n√£o pode ser desfeita.')) return;
  try {
    await remove(ref(db, 'resultados'));
    alert('Todos os resultados foram apagados com sucesso.');
  } catch (err) {
    console.error('Erro ao apagar resultados:', err);
    alert('Erro ao limpar resultados: ' + (err.message || err));
  }
});

// Bot√£o para imprimir resultados filtrados
const btnImprimirResultados = document.getElementById('btn-imprimir-resultados');
btnImprimirResultados.addEventListener('click', () => {
  // Verifica se h√° resultados exibidos
  if (!filteredResultadosCache || filteredResultadosCache.length === 0) {
    alert('Nenhum resultado dispon√≠vel para impress√£o.');
    return;
  }

  // Monta HTML de impress√£o
  const win = window.open('', '_blank');
  win.document.write(`
    <html>
      <head>
        <title>Resultados Filtrados</title>
        <style>
          body { font-family: Arial, sans-serif; margin: 20px; }
          h2 { text-align: center; }
          table { width: 100%; border-collapse: collapse; margin-top: 20px; }
          th, td { border: 1px solid #ccc; padding: 8px; text-align: left; font-size: 14px; }
          th { background: #f0f0f0; }
          tr:nth-child(even) { background: #fafafa; }
          @media print {
            button { display: none; }
          }
        </style>
      </head>
      <body>
        <h2>Resultados Filtrados</h2>
        <table>
          <thead>
            <tr>
              <th>Posi√ß√£o</th>
              <th>N√∫mero</th>
              <th>Atleta</th>
              <th>Modalidade</th>
              <th>Categoria</th>
              <th>G√™nero</th>
              <th>Chegada</th>
              <th>Tempo</th>
              <th>Voltas</th>
            </tr>
          </thead>
          <tbody>
            ${filteredResultadosCache.map((r, i) => `
              <tr>
                <td>${i + 1}¬∫</td>
                <td>${r.numero}</td>
                <td>${r.atleta || ''}</td>
                <td>${r.modalidade || ''}</td>
                <td>${r.categoria || ''}</td>
                <td>${r.genero || ''}</td>
                <td>${r.chegada || ''}</td>
                <td>${r.tempo || ''}</td>
                <td>${r.totalVoltas ? r.totalVoltas : ''}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
        <div style="text-align:center;margin-top:30px;">
          <button onclick="window.print()">üñ®Ô∏è Imprimir</button>
        </div>
      </body>
    </html>
  `);
  win.document.close();
  win.focus();
});
// Bot√£o para limpar o hist√≥rico dos √∫ltimos 10 atletas registrados
const btnLimparUltimos = document.getElementById('btn-limpar-ultimos');
btnLimparUltimos.addEventListener('click', async () => {
  if (isVisitor || !auth.currentUser) {
    alert('A√ß√£o proibida: modo visitante. Fa√ßa login para limpar o hist√≥rico.');
    return;
  }
  if (!confirm('Tem certeza que deseja apagar o hist√≥rico dos √∫ltimos 10 atletas registrados?')) return;
  try {
    await remove(ref(db, 'ultimosRegistrados'));
    alert('Hist√≥rico apagado com sucesso.');
  } catch (err) {
    console.error('Erro ao apagar √∫ltimos registrados:', err);
    alert('Erro ao limpar hist√≥rico: ' + (err.message || err));
  }
});

    // Focus management (only on Entrada page)
    let focusInterval = null;
    function enableEntradaFocus(){
      if(!auth.currentUser || !numeroInput || numeroInput.offsetParent === null) return;
      numeroInput.focus();
      if(focusInterval) clearInterval(focusInterval);
      focusInterval = setInterval(()=>{
        if(document.activeElement !== numeroInput && numeroInput.offsetParent !== null){
          numeroInput.focus();
        }
      }, 900);
    }
    function disableEntradaFocus(){
      if(focusInterval) { clearInterval(focusInterval); focusInterval = null; }
    }

    // State
    let latestListagem = [];
    let latestLargadas = [];
    let latestResultados = [];
    let latestVoltasMtb = [];
    let latestVoltasDuathlon = [];
    let filteredResultadosCache = [];
    let isVisitor = false;
    let atletaSelecionadoComprovante = null;
    let formatoComprovanteAtual = 'story';

    // Auth handlers
    btnLogin.onclick = async () => {
      try{
        await signInWithEmailAndPassword(auth, emailInput.value, passInput.value);
      }catch(err){
        authError.style.display='block';
        authError.textContent = 'Erro login: ' + err.message;
        console.error(err);
      }
    };
    btnRegister.onclick = async () => {
      try{
        await createUserWithEmailAndPassword(auth, emailInput.value, passInput.value);
        alert('Conta criada. Fa√ßa login.');
      }catch(err){
        authError.style.display='block';
        authError.textContent = 'Erro criar conta: ' + err.message;
        console.error(err);
      }
    };
    btnLogout.onclick = async ()=>{ 
      if(isVisitor){
        isVisitor = false;
        authCard.classList.remove('hidden');
        appCard.classList.add('hidden');
        userArea.textContent = '';
        navEntrada.style.display = '';
        navVoltasMtb.style.display = '';
        navVoltasDuathlon.style.display = '';
        navListagem.style.display = '';
        navLargadas.style.display = '';
        showPage('entrada');
      } else {
        await signOut(auth); 
      }
    };

    // Entrar como visitante
    btnVisitante.onclick = () => {
      isVisitor = true;
      authCard.classList.add('hidden');
      appCard.classList.remove('hidden');
      userArea.textContent = 'Visitante (somente leitura)';
      navEntrada.style.display = 'none';
      navVoltasMtb.style.display = 'none';
      navVoltasDuathlon.style.display = 'none';
      navListagem.style.display = 'none';
      navLargadas.style.display = 'none';
      numeroInput.classList.add('disabled');
      numeroInput.setAttribute('disabled','true');
      btnLimpar.classList.add('disabled');
      btnLimpar.setAttribute('disabled','true');
      btnAddAthlete.classList.add('disabled'); btnAddAthlete.setAttribute('disabled','true');
      csvUpload.classList.add('disabled'); csvUpload.disabled = true;
      btnAddLargada.classList.add('disabled'); btnAddLargada.setAttribute('disabled','true');
      startRealtimeListeners();
      showPage('resultados');
    };

    onAuthStateChanged(auth, user => {
      if(user){
        isVisitor = false;
        authCard.classList.add('hidden');
        appCard.classList.remove('hidden');
        userArea.textContent = user.email;
        navEntrada.style.display = '';
        navVoltasMtb.style.display = '';
        navVoltasDuathlon.style.display = '';
        navListagem.style.display = '';
        navLargadas.style.display = '';
        numeroInput.classList.remove('disabled'); numeroInput.removeAttribute('disabled');
        btnLimpar.classList.remove('disabled'); btnLimpar.removeAttribute('disabled');
        btnAddAthlete.classList.remove('disabled'); btnAddAthlete.removeAttribute('disabled');
        csvUpload.classList.remove('disabled'); csvUpload.disabled = false;
        btnAddLargada.classList.remove('disabled'); btnAddLargada.removeAttribute('disabled');
        startRealtimeListeners();
        showPage('entrada');
      } else {
        if(!isVisitor){
          authCard.classList.remove('hidden');
          appCard.classList.add('hidden');
          userArea.textContent = '';
          disableEntradaFocus();
        }
      }
    });

    // Navigation
    navEntrada.addEventListener('click', ()=> { if(isVisitor){ alert('Modo visitante: acesso somente leitura.'); return; } showPage('entrada'); });
    navVoltasMtb.addEventListener('click', ()=> { if(isVisitor){ alert('Modo visitante: acesso somente leitura.'); return; } showPage('voltas-mtb'); });
    navVoltasDuathlon.addEventListener('click', ()=> { if(isVisitor){ alert('Modo visitante: acesso somente leitura.'); return; } showPage('voltas-duathlon'); });
    navListagem.addEventListener('click', ()=> { if(isVisitor){ alert('Modo visitante: acesso somente leitura.'); return; } showPage('listagem'); });
    navLargadas.addEventListener('click', ()=> { if(isVisitor){ alert('Modo visitante: acesso somente leitura.'); return; } showPage('largadas'); });
    navResultados.addEventListener('click', ()=> showPage('resultados'));

    function showPage(p){
      pageEntrada.classList.add('hidden');
      pageVoltasMtb.classList.add('hidden');
      pageVoltasDuathlon.classList.add('hidden');
      pageListagem.classList.add('hidden');
      pageLargadas.classList.add('hidden');
      pageResultados.classList.add('hidden');
      disableEntradaFocus();
      entradaSuccess.style.display = 'none';
      entradaError.style.display = 'none';
      entradaWarning.style.display = 'none';
      
      if(p==='entrada'){ 
        if(isVisitor){ alert('Modo visitante: apenas Resultados dispon√≠veis.'); showPage('resultados'); return; }
        pageEntrada.classList.remove('hidden'); enableEntradaFocus(); 
      }
      if(p==='voltas-mtb'){ if(isVisitor){ alert('Modo visitante: apenas Resultados dispon√≠veis.'); showPage('resultados'); return; } pageVoltasMtb.classList.remove('hidden'); }
      if(p==='voltas-duathlon'){ if(isVisitor){ alert('Modo visitante: apenas Resultados dispon√≠veis.'); showPage('resultados'); return; } pageVoltasDuathlon.classList.remove('hidden'); }
      if(p==='listagem'){ if(isVisitor){ alert('Modo visitante: apenas Resultados dispon√≠veis.'); showPage('resultados'); return; } pageListagem.classList.remove('hidden'); }
      if(p==='largadas'){ if(isVisitor){ alert('Modo visitante: apenas Resultados dispon√≠veis.'); showPage('resultados'); return; } pageLargadas.classList.remove('hidden'); }
      if(p==='resultados') pageResultados.classList.remove('hidden');
    }

    // Enter registers arrival
    numeroInput.addEventListener('keydown', (e) => {
      if(e.key === 'Enter'){
        e.preventDefault();
        registrarChegada();
      }
    });
    btnLimpar.addEventListener('click', ()=>{ numeroInput.value = ''; numeroInput.focus(); });

    // Filtro de voltas MTB
    filtroVoltasNumero.addEventListener('input', () => {
      renderVoltasMtb(latestVoltasMtb);
    });

// Bot√£o para limpar todos os registros de voltas MTB
const btnLimparVoltas = document.getElementById('btn-limpar-voltas');
btnLimparVoltas.addEventListener('click', async () => {
  if (isVisitor || !auth.currentUser) {
    alert('A√ß√£o proibida: modo visitante. Fa√ßa login para limpar voltas.');
    return;
  }
  if (!confirm('Tem certeza que deseja apagar TODOS os registros de voltas MTB? Essa a√ß√£o n√£o pode ser desfeita.')) return;
  try {
    await remove(ref(db, 'voltasMtb'));
    alert('Todos os registros de voltas MTB foram apagados com sucesso.');
  } catch (err) {
    console.error('Erro ao apagar voltas MTB:', err);
    alert('Erro ao limpar voltas MTB: ' + (err.message || err));
  }
});

// Bot√£o para limpar todos os registros de voltas Duathlon
const btnLimparVoltasDuathlon = document.getElementById('btn-limpar-voltas-duathlon');
btnLimparVoltasDuathlon.addEventListener('click', async () => {
  if (isVisitor || !auth.currentUser) {
    alert('A√ß√£o proibida: modo visitante. Fa√ßa login para limpar voltas.');
    return;
  }
  if (!confirm('Tem certeza que deseja apagar TODOS os registros de voltas Duathlon? Essa a√ß√£o n√£o pode ser desfeita.')) return;
  try {
    await remove(ref(db, 'voltasDuathlon'));
    alert('Todos os registros de voltas Duathlon foram apagados com sucesso.');
  } catch (err) {
    console.error('Erro ao apagar voltas Duathlon:', err);
    alert('Erro ao limpar voltas Duathlon: ' + (err.message || err));
  }
});

    btnLimparFiltroVoltas.addEventListener('click', () => {
      filtroVoltasNumero.value = '';
      renderVoltasMtb(latestVoltasMtb);
    });

    // Filtro de voltas Duathlon
    filtroVoltasDuathlonNumero.addEventListener('input', () => {
      renderVoltasDuathlon(latestVoltasDuathlon);
    });

    btnLimparFiltroVoltasDuathlon.addEventListener('click', () => {
      filtroVoltasDuathlonNumero.value = '';
      renderVoltasDuathlon(latestVoltasDuathlon);
    });

      async function registrarChegada(){
      if(isVisitor || !auth.currentUser){
        alert('A√ß√£o proibida: modo visitante ou n√£o autenticado. Fa√ßa login para registrar chegadas.');
        return;
      }
      const raw = (numeroInput.value || '').trim();
      if(!raw){ numeroInput.focus(); return; }
      const numero = padNum(raw.replace(/\D/g,''));
      
      try{
        // Verificar se atleta existe
        const athleteSnap = await get(child(ref(db), `listagem/${numero}`));
        if(!athleteSnap.exists()){
          if(!confirm(`Atleta ${numero} n√£o encontrado. Deseja cadastrar rapidamente?`)) {
            numeroInput.value=''; numeroInput.focus(); return;
          }
          await quickRegisterAthlete(numero);
        }
        
        const athlete = (await get(child(ref(db), `listagem/${numero}`))).val();
        
        // VERIFICAR DUPLICA√á√ÉO (exceto MTB e Duathlon Cross)
        if(athlete.modalidade !== 'MTB' && athlete.modalidade !== 'DUATHLON CROSS'){
          const resultadoSnap = await get(child(ref(db), `resultados/${numero}`));
          if(resultadoSnap.exists()){
            entradaError.textContent = `Atleta ${numero} j√° possui chegada registrada!`;
            entradaError.style.display = 'block';
            numeroInput.value = '';
            numeroInput.focus();
            return;
          }
        }

        let largadaInicioStr = null;
        if(athlete && athlete.modalidade){
          const largSnap = await get(child(ref(db), `largadas/${athlete.modalidade}/inicio`));
          if(largSnap.exists()) largadaInicioStr = largSnap.val();
        }
        
        const chegadaDt = new Date();
        const chegadaStr = formatDMYTime(chegadaDt);
        let tempoStr = null;
        
        if(largadaInicioStr){
          const largDt = parseDMYTime(largadaInicioStr);
          const diffSec = Math.round((chegadaDt.getTime() - largDt.getTime())/1000);
          tempoStr = formatTempoFromSeconds(diffSec);
        }

        // Se for MTB ou Duathlon Cross, registrar como volta especial
        if(athlete.modalidade === 'MTB' || athlete.modalidade === 'DUATHLON CROSS'){
          // Verificar intervalo m√≠nimo para MTB e Duathlon
          let voltasAtleta = [];
          if(athlete.modalidade === 'MTB') {
            voltasAtleta = latestVoltasMtb[numero] || [];
          } else if(athlete.modalidade === 'DUATHLON CROSS') {
            voltasAtleta = latestVoltasDuathlon[numero] || [];
          }
          
          const podeRegistrar = verificarIntervaloMinimo(voltasAtleta);
          
          if (!podeRegistrar) {
            entradaWarning.textContent = `Aguarde 3 minutos entre as voltas! Atleta ${numero} registrou volta recentemente.`;
            entradaWarning.style.display = 'block';
            numeroInput.value = '';
            numeroInput.focus();
            return;
          }
          
          if(athlete.modalidade === 'MTB') {
            await registrarVoltaMtbFirebase(numero, athlete, chegadaStr, tempoStr);
            entradaSuccess.textContent = `Volta registrada para atleta ${numero} (MTB)`;
          } else {
            await registrarVoltaDuathlonFirebase(numero, athlete, chegadaStr, tempoStr);
            entradaSuccess.textContent = `Volta registrada para atleta ${numero} (Duathlon Cross)`;
          }
          entradaSuccess.style.display = 'block';
        } else {
          // Outras modalidades: registro normal
          await set(ref(db, `resultados/${numero}`), {
            chegada: chegadaStr,
            tempo: tempoStr || '',
            atleta: (athlete && athlete.atleta) || '',
            genero: (athlete && athlete.genero) || '',
            modalidade: (athlete && athlete.modalidade) || '',
            categoria: (athlete && athlete.categoria) || '',
            data_nascimento: (athlete && athlete.data_nascimento) || '',
            idade: (athlete && athlete.idade) || '',
            registradoPor: auth.currentUser ? auth.currentUser.email : null,
            registradaEmISO: new Date().toISOString()
          });
          entradaSuccess.textContent = `Chegada registrada para atleta ${numero}`;
          entradaSuccess.style.display = 'block';
        }
        
        pushLastRegistrado(numero);
        numeroInput.value = '';
        numeroInput.focus();
        
        // ATUALIZAR RESULTADOS AUTOMATICAMENTE AP√ìS REGISTRO
        atualizarResultadosAutomaticamente();
        
      }catch(err){
        console.error('Erro registrar chegada:', err);
        entradaError.textContent = 'Erro ao registrar chegada: ' + (err.message||err);
        entradaError.style.display = 'block';
      }
    }

    // Fun√ß√£o para atualizar resultados automaticamente
    function atualizarResultadosAutomaticamente() {
      renderResultados(latestResultados);
    }

    async function registrarVoltaMtbFirebase(numero, athlete, dataHora, tempo){
      const voltaRef = push(ref(db, `voltasMtb/${numero}`));
      await set(voltaRef, {
        numero: numero,
        atleta: athlete.atleta || '',
        genero: athlete.genero || '',
        categoria: athlete.categoria || '',
        dataHora: dataHora,
        tempo: tempo || '',
        registradoPor: auth.currentUser ? auth.currentUser.email : null,
        registradaEmISO: new Date().toISOString()
      });
    }

    async function registrarVoltaDuathlonFirebase(numero, athlete, dataHora, tempo){
      const voltaRef = push(ref(db, `voltasDuathlon/${numero}`));
      await set(voltaRef, {
        numero: numero,
        atleta: athlete.atleta || '',
        genero: athlete.genero || '',
        categoria: athlete.categoria || '',
        dataHora: dataHora,
        tempo: tempo || '',
        registradoPor: auth.currentUser ? auth.currentUser.email : null,
        registradaEmISO: new Date().toISOString()
      });
    }

    // Quick register modal
    async function quickRegisterAthlete(numero){
      if(isVisitor || !auth.currentUser) {
        alert('A√ß√£o proibida: modo visitante. Fa√ßa login para cadastrar atletas.');
        return;
      }
      return new Promise((resolve, reject)=>{
        const overlay = document.createElement('div'); overlay.className='overlay';
        const form = document.createElement('form'); form.className='modal';
        form.innerHTML = `
          <h4>Cadastro R√°pido - ${numero}</h4>
          <input id="q_atleta" placeholder="Nome (Atleta)" required />
          <input id="q_genero" placeholder="G√™nero (ex: Feminino)" />
          <select id="q_modalidade">
            <option value="">Selecione a modalidade</option>
            <option value="MTB">MTB</option>
            <option value="TRAIL RUN">TRAIL RUN</option>
            <option value="DUATHLON CROSS">DUATHLON CROSS</option>
          </select>
          <input id="q_categoria" placeholder="Categoria" />
          <input id="q_data_nasc" placeholder="Data Nascimento (DD/MM/YYYY)" />
          <input id="q_idade" placeholder="Idade" type="number" />
          <div class="form-actions">
            <button type="button" id="q_cancel" class="ghost">Cancelar</button>
            <button type="submit">Salvar</button>
          </div>
        `;
        document.body.appendChild(overlay); document.body.appendChild(form);
        form.q_atleta.focus();
        form.q_cancel.onclick = ()=>{ form.remove(); overlay.remove(); resolve(); };
        form.onsubmit = async (e)=>{
          e.preventDefault();
          try{
            await set(ref(db, `listagem/${numero}`), {
              atleta: form.q_atleta.value,
              genero: form.q_genero.value,
              modalidade: form.q_modalidade.value,
              categoria: form.q_categoria.value,
              data_nascimento: form.q_data_nasc.value,
              idade: form.q_idade.value
            });
            form.remove(); overlay.remove(); resolve();
          }catch(err){ form.remove(); overlay.remove(); reject(err); }
        };
      });
    }

    // CSV upload (listagem)
    csvUpload.addEventListener('change', (e)=>{
      if(isVisitor || !auth.currentUser){
        alert('A√ß√£o proibida: modo visitante. Fa√ßa login para importar CSV.');
        csvUpload.value = '';
        return;
      }
      const file = e.target.files[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = async () => {
        const text = reader.result;
        const lines = text.split(/\r?\n/).filter(Boolean);
        let start = 0;
        if(lines.length>0){
          const firstCols = lines[0].split(',');
          if(isNaN(Number(firstCols[0].replace(/\D/g,'')))) start = 1;
        }
        try{
          for(let i=start; i<lines.length; i++){
            const cols = lines[i].split(',').map(c=>c.trim());
            if(cols.length < 2) continue;
            const rawNumero = cols[0].replace(/\D/g,'');
            if(!rawNumero) continue;
            const numero = padNum(rawNumero);
            const data = {
              atleta: cols[1] || '',
              genero: cols[2] || '',
              modalidade: cols[3] || '',
              categoria: cols[4] || '',
              data_nascimento: cols[5] || '',
              idade: cols[6] || ''
            };
            await set(ref(db, `listagem/${numero}`), data);
          }
          alert('CSV importado com sucesso!');
          csvUpload.value = '';
        }catch(err){
          console.error('Erro importar CSV', err);
          alert('Erro ao importar CSV: ' + (err.message||err));
        }
      };
      reader.readAsText(file, 'utf-8');
    });

    // Bot√£o para limpar lista completa de atletas
const btnLimparListagem = document.getElementById('btn-limpar-listagem');
btnLimparListagem.addEventListener('click', async () => {
  if (isVisitor || !auth.currentUser) {
    alert('A√ß√£o proibida: modo visitante. Fa√ßa login para limpar a listagem.');
    return;
  }
  if (!confirm('Tem certeza que deseja apagar TODOS os atletas registrados? Essa a√ß√£o n√£o pode ser desfeita.')) return;
  try {
    await remove(ref(db, 'listagem'));
    alert('Todos os atletas foram apagados com sucesso.');
  } catch (err) {
    console.error('Erro ao apagar lista de atletas:', err);
    alert('Erro ao limpar lista: ' + (err.message || err));
  }
});

    btnAddAthlete.onclick = ()=>{
      if(isVisitor || !auth.currentUser){ alert('A√ß√£o proibida: modo visitante. Fa√ßa login para adicionar atletas.'); return; }
      const overlay = document.createElement('div'); overlay.className='overlay';
      const form = document.createElement('form'); form.className='modal';
      form.innerHTML = `
        <h4>Novo Atleta</h4>
        <input id="a_numero" placeholder="N√∫mero (ex: 1 ou 0001)" required />
        <input id="a_nome" placeholder="Nome" required />
        <input id="a_genero" placeholder="G√™nero" />
        <select id="a_modalidade">
          <option value="">Selecione a modalidade</option>
          <option value="MTB">MTB</option>
          <option value="TRAIL RUN">TRAIL RUN</option>
          <option value="DUATHLON CROSS">DUATHLON CROSS</option>
        </select>
        <input id="a_categoria" placeholder="Categoria" />
        <input id="a_data_nasc" placeholder="Data Nascimento (DD/MM/YYYY)" />
        <input id="a_idade" placeholder="Idade" type="number" />
        <div class="form-actions">
          <button type="button" id="a_cancel" class="ghost">Cancelar</button>
          <button type="submit">Salvar</button>
        </div>
      `;
      document.body.appendChild(overlay); document.body.appendChild(form);
      form.a_numero.focus();
      form.a_cancel.onclick = ()=>{ form.remove(); overlay.remove(); };
      form.onsubmit = async (e)=>{
        e.preventDefault();
        const raw = form.a_numero.value.replace(/\D/g,'');
        if(!raw){ alert('N√∫mero inv√°lido'); return; }
        const numero = padNum(raw);
        try{
          await set(ref(db, `listagem/${numero}`), {
            atleta: form.a_nome.value,
            genero: form.a_genero.value,
            modalidade: form.a_modalidade.value,
            categoria: form.a_categoria.value,
            data_nascimento: form.a_data_nasc.value,
            idade: form.a_idade.value
          });
          form.remove(); overlay.remove();
        }catch(err){ console.error(err); alert('Erro ao salvar: '+(err.message||err)); }
      };
    };

    // New largada modal
    btnAddLargada.onclick = ()=>{
      if(isVisitor || !auth.currentUser){ alert('A√ß√£o proibida: modo visitante. Fa√ßa login para adicionar largadas.'); return; }
      const overlay = document.createElement('div'); overlay.className='overlay';
      const form = document.createElement('form'); form.className='modal';
      form.innerHTML = `
        <h4>Nova Largada</h4>
        <input id="l_modalidade" placeholder="Modalidade (ex: MTB)" required />
        <label class="small">In√≠cio (DD/MM/YYYY HH:MM:SS)</label>
        <input id="l_inicio" placeholder="22/10/2025 08:00:00" required />
        <div class="form-actions">
          <button type="button" id="l_cancel" class="ghost">Cancelar</button>
          <button type="submit">Salvar</button>
        </div>
      `;
      document.body.appendChild(overlay); document.body.appendChild(form);
      form.l_modalidade.focus();
      form.l_cancel.onclick = ()=>{ form.remove(); overlay.remove(); };
      form.onsubmit = async (e)=>{
        e.preventDefault();
        const modalidade = form.l_modalidade.value.trim();
        const inicioStr = form.l_inicio.value.trim();
        if(!modalidade || !inicioStr){ alert('Preencha todos os campos'); return; }
        try{
          await set(ref(db, `largadas/${modalidade}/inicio`), inicioStr);
          form.remove(); overlay.remove();
        }catch(err){ console.error(err); alert('Erro ao salvar largada: '+(err.message||err)); }
      };
    };

    // Real-time listeners and state
    function startRealtimeListeners(){
      renderUltimosRegistrados();
      
      onValue(ref(db, 'listagem'), (snap)=>{
        const data = snap.val() || {};
        latestListagem = Object.keys(data).map(k => Object.assign({numero: k}, data[k]));
        renderListagem(latestListagem);
        rebuildResultFilters();
      }, (err)=>{ console.error('Erro listener listagem:', err); });

      onValue(ref(db, 'largadas'), (snap)=>{
        const data = snap.val() || {};
        latestLargadas = Object.keys(data).map(k => ({modalidade: k, inicio: data[k].inicio || ''}));
        renderLargadas(latestLargadas);
        rebuildResultFilters();
      }, (err)=>{ console.error('Erro listener largadas:', err); });

      onValue(ref(db, 'resultados'), (snap)=>{
        const data = snap.val() || {};
        latestResultados = Object.keys(data).map(k => Object.assign({numero: k}, data[k]));
        renderResultados(latestResultados);
      }, (err)=>{ console.error('Erro listener resultados:', err); });

      onValue(ref(db, 'voltasMtb'), (snap)=>{
        const data = snap.val() || {};
        const voltasPorAtleta = {};
        Object.keys(data).forEach(numero => {
          const voltasAtleta = data[numero];
          if(voltasAtleta && typeof voltasAtleta === 'object'){
            voltasPorAtleta[numero] = Object.keys(voltasAtleta).map(key => {
              return Object.assign({id: key}, voltasAtleta[key]);
            });
          }
        });
        latestVoltasMtb = voltasPorAtleta;
        renderVoltasMtb(voltasPorAtleta);
        rebuildResultFilters();
      }, (err)=>{ console.error('Erro listener voltas MTB:', err); });

      onValue(ref(db, 'voltasDuathlon'), (snap)=>{
        const data = snap.val() || {};
        const voltasPorAtleta = {};
        Object.keys(data).forEach(numero => {
          const voltasAtleta = data[numero];
          if(voltasAtleta && typeof voltasAtleta === 'object'){
            voltasPorAtleta[numero] = Object.keys(voltasAtleta).map(key => {
              return Object.assign({id: key}, voltasAtleta[key]);
            });
          }
        });
        latestVoltasDuathlon = voltasPorAtleta;
        renderVoltasDuathlon(voltasPorAtleta);
        rebuildResultFilters();
      }, (err)=>{ console.error('Erro listener voltas Duathlon:', err); });
    }
function renderListagem(rows){
      const q = (searchListagem.value || '').trim().toLowerCase();
      const filtered = rows.filter(r => !q || (r.numero && r.numero.toLowerCase().includes(q)) || (r.atleta && r.atleta.toLowerCase().includes(q)));
      let html = `<table><thead><tr><th>N√∫mero</th><th>Nome</th><th>G√™nero</th><th>Modalidade</th><th>Categoria</th><th>Idade</th><th>A√ß√µes</th></tr></thead><tbody>`;
      filtered.forEach(r=>{
        html += `<tr>
          <td>${r.numero}</td>
          <td>${escapeHtml(r.atleta||'')}</td>
          <td>${escapeHtml(r.genero||'')}</td>
          <td>${escapeHtml(r.modalidade||'')}</td>
          <td>${escapeHtml(r.categoria||'')}</td>
          <td>${escapeHtml(r.idade||'')}</td>
          <td>`;
        if(!isVisitor && auth.currentUser){
          html += `<button data-num="${r.numero}" class="btn-edit">Editar</button>
                   <button data-num="${r.numero}" class="btn-delete ghost">Apagar</button>`;
        } else {
          html += `<span class="small" style="color:#666">Somente leitura</span>`;
        }
        html += `</td></tr>`;
      });
      html += `</tbody></table>`;
      tableListagem.innerHTML = html;
      if(!isVisitor && auth.currentUser){
        tableListagem.querySelectorAll('.btn-edit').forEach(btn=> btn.onclick = ()=> openEditAthlete(btn.dataset.num) );
        tableListagem.querySelectorAll('.btn-delete').forEach(btn=> btn.onclick = async ()=>{ if(!confirm(`Apagar atleta ${btn.dataset.num}?`)) return; try{ await remove(ref(db, `listagem/${btn.dataset.num}`)); alert('Apagado'); }catch(err){ console.error(err); alert('Erro: '+(err.message||err)); } });
      }
    }

    function renderVoltasMtb(voltasPorAtleta){
      const filtroNumero = (filtroVoltasNumero.value || '').trim().toLowerCase();
      
      let html = `<table><thead><tr><th>N√∫mero</th><th>Atleta</th><th>Volta #</th><th>Data/Hora</th><th>Tempo</th><th>Registrado Por</th></tr></thead><tbody>`;
      
      const numerosOrdenados = Object.keys(voltasPorAtleta).sort((a, b) => {
        return parseInt(a) - parseInt(b);
      });
      
      numerosOrdenados.forEach(numero => {
        if(filtroNumero && !numero.includes(filtroNumero)) return;
        
        const voltas = voltasPorAtleta[numero];
        if(voltas && voltas.length > 0){
          voltas.sort((a, b) => {
            const dtA = parseDMYTime(a.dataHora) || new Date(a.registradaEmISO);
            const dtB = parseDMYTime(b.dataHora) || new Date(b.registradaEmISO);
            return dtA - dtB;
          });
          
          voltas.forEach((volta, index) => {
            html += `<tr>
              <td>${numero}</td>
              <td>${escapeHtml(volta.atleta||'')}</td>
              <td><strong>${index + 1}</strong></td>
              <td>${escapeHtml(volta.dataHora||'')}</td>
              <td>${escapeHtml(volta.tempo||'')}</td>
              <td class="small">${escapeHtml(volta.registradoPor||'')}</td>
            </tr>`;
          });
        }
      });
      
      html += `</tbody></table>`;
      tableVoltasMtb.innerHTML = html;
    }

    function renderVoltasDuathlon(voltasPorAtleta){
      const filtroNumero = (filtroVoltasDuathlonNumero.value || '').trim().toLowerCase();
      
      let html = `<table><thead><tr><th>N√∫mero</th><th>Atleta</th><th>Volta #</th><th>Data/Hora</th><th>Tempo</th><th>Registrado Por</th></tr></thead><tbody>`;
      
      const numerosOrdenados = Object.keys(voltasPorAtleta).sort((a, b) => {
        return parseInt(a) - parseInt(b);
      });
      
      numerosOrdenados.forEach(numero => {
        if(filtroNumero && !numero.includes(filtroNumero)) return;
        
        const voltas = voltasPorAtleta[numero];
        if(voltas && voltas.length > 0){
          voltas.sort((a, b) => {
            const dtA = parseDMYTime(a.dataHora) || new Date(a.registradaEmISO);
            const dtB = parseDMYTime(b.dataHora) || new Date(b.registradaEmISO);
            return dtA - dtB;
          });
          
          voltas.forEach((volta, index) => {
            html += `<tr>
              <td>${numero}</td>
              <td>${escapeHtml(volta.atleta||'')}</td>
              <td><strong>${index + 1}</strong></td>
              <td>${escapeHtml(volta.dataHora||'')}</td>
              <td>${escapeHtml(volta.tempo||'')}</td>
              <td class="small">${escapeHtml(volta.registradoPor||'')}</td>
            </tr>`;
          });
        }
      });
      
      html += `</tbody></table>`;
      tableVoltasDuathlon.innerHTML = html;
    }

    // Edit athlete from Listagem
    function openEditAthlete(numero){
      if(isVisitor || !auth.currentUser){ alert('A√ß√£o proibida: modo visitante. Fa√ßa login para editar.'); return; }
      get(child(ref(db), `listagem/${numero}`)).then(snap=>{
        const data = snap.exists() ? snap.val() : {};
        const overlay = document.createElement('div'); overlay.className='overlay';
        const form = document.createElement('form'); form.className='modal';
        form.innerHTML = `
          <h4>Editar Atleta - ${numero}</h4>
          <label class="small">N√∫mero</label>
          <input id="e_numero" placeholder="N√∫mero" value="${escapeAttr(numero)}" />
          <input id="e_nome" placeholder="Nome" value="${escapeAttr(data.atleta||'')}" />
          <input id="e_genero" placeholder="G√™nero" value="${escapeAttr(data.genero||'')}" />
          <select id="e_modalidade">
            <option value="">Selecione a modalidade</option>
            <option value="MTB" ${data.modalidade==='MTB'?'selected':''}>MTB</option>
            <option value="TRAIL RUN" ${data.modalidade==='TRAIL RUN'?'selected':''}>TRAIL RUN</option>
            <option value="DUATHLON CROSS" ${data.modalidade==='DUATHLON CROSS'?'selected':''}>DUATHLON CROSS</option>
          </select>
          <input id="e_categoria" placeholder="Categoria" value="${escapeAttr(data.categoria||'')}" />
          <input id="e_data_nasc" placeholder="Data Nascimento (DD/MM/YYYY)" value="${escapeAttr(data.data_nascimento||'')}" />
          <input id="e_idade" placeholder="Idade" type="number" value="${escapeAttr(data.idade||'')}" />
          <div class="form-actions">
            <button type="button" id="e_cancel" class="ghost">Cancelar</button>
            <button type="submit">Salvar</button>
          </div>
        `;
        document.body.appendChild(overlay); document.body.appendChild(form);
        form.e_cancel.onclick = ()=>{ form.remove(); overlay.remove(); };
        form.onsubmit = async (e)=>{
          e.preventDefault();
          try{
            const rawNew = (form.e_numero.value || '').replace(/\D/g,'');
            if(!rawNew){ alert('N√∫mero inv√°lido'); return; }
            const newNumero = padNum(rawNew);
            const payload = {
              atleta: form.e_nome.value,
              genero: form.e_genero.value,
              modalidade: form.e_modalidade.value,
              categoria: form.e_categoria.value,
              data_nascimento: form.e_data_nasc.value,
              idade: form.e_idade.value
            };
            if(newNumero === numero){
              await update(ref(db, `listagem/${numero}`), payload);
            } else {
              const existsNew = (await get(child(ref(db), `listagem/${newNumero}`))).exists();
              if(existsNew){
                if(!confirm(`J√° existe atleta com n√∫mero ${newNumero}. Deseja sobrescrever?`)) { return; }
              }
              await set(ref(db, `listagem/${newNumero}`), payload);
              await remove(ref(db, `listagem/${numero}`));
              const resSnap = await get(child(ref(db), `resultados/${numero}`));
              if(resSnap.exists()){
                const resData = resSnap.val();
                await set(ref(db, `resultados/${newNumero}`), Object.assign({}, resData, {
                  atleta: payload.atleta || resData.atleta,
                  modalidade: payload.modalidade || resData.modalidade,
                  categoria: payload.categoria || resData.categoria,
                  genero: payload.genero || resData.genero
                }));
                await remove(ref(db, `resultados/${numero}`));
              }
            }
            form.remove(); overlay.remove();
          }catch(err){ console.error(err); alert('Erro salvar: '+(err.message||err)); }
        };
      });
    }

    function renderLargadas(rows){
      let html = `<table><thead><tr><th>Modalidade</th><th>In√≠cio</th><th>A√ß√µes</th></tr></thead><tbody>`;
      rows.forEach(r=>{
        html += `<tr>
          <td>${escapeHtml(r.modalidade||'')}</td>
          <td>${escapeHtml(r.inicio||'')}</td>
          <td>`;
        if(!isVisitor && auth.currentUser){
          html += `<button data-mod="${r.modalidade}" class="btn-edit-l">Editar</button>
                   <button data-mod="${r.modalidade}" class="btn-del-l ghost">Apagar</button>`;
        } else {
          html += `<span class="small" style="color:#666">Somente leitura</span>`;
        }
        html += `</td></tr>`;
      });
      html += `</tbody></table>`;
      tableLargadas.innerHTML = html;
      if(!isVisitor && auth.currentUser){
        tableLargadas.querySelectorAll('.btn-edit-l').forEach(btn=> btn.onclick = ()=> openEditLargada(btn.dataset.mod) );
        tableLargadas.querySelectorAll('.btn-del-l').forEach(btn=> btn.onclick = async ()=>{ if(!confirm(`Apagar largada ${btn.dataset.mod}?`)) return; try{ await remove(ref(db, `largadas/${btn.dataset.mod}`)); alert('Apagado'); }catch(err){ console.error(err); alert('Erro: '+(err.message||err)); } });
      }
    }

    function openEditLargada(modalidade){
      if(isVisitor || !auth.currentUser){ alert('A√ß√£o proibida: modo visitante. Fa√ßa login para editar largadas.'); return; }
      get(child(ref(db), `largadas/${modalidade}/inicio`)).then(snap=>{
        const inicio = snap.exists() ? snap.val() : '';
        const overlay = document.createElement('div'); overlay.className='overlay';
        const form = document.createElement('form'); form.className='modal';
        form.innerHTML = `
          <h4>Editar Largada - ${modalidade}</h4>
          <label class="small">In√≠cio (DD/MM/YYYY HH:MM:SS)</label>
          <input id="el_inicio" value="${escapeAttr(inicio||'')}" />
          <div class="form-actions">
            <button type="button" id="el_cancel" class="ghost">Cancelar</button>
            <button type="submit">Salvar</button>
          </div>
        `;
        document.body.appendChild(overlay); document.body.appendChild(form);
        form.el_cancel.onclick = ()=>{ form.remove(); overlay.remove(); };
        form.onsubmit = async (e)=>{
          e.preventDefault();
          try{
            await set(ref(db, `largadas/${modalidade}/inicio`), form.el_inicio.value);
            form.remove(); overlay.remove();
          }catch(err){ console.error(err); alert('Erro salvar: '+(err.message||err)); }
        };
      });
    }

    // Sistema de Comprovantes
    btnComprovante.addEventListener('click', () => {
      if (isVisitor) {
        if (filteredResultadosCache.length === 0) {
          alert('Nenhum resultado dispon√≠vel para gerar comprovante.');
          return;
        }
        alert('Clique no bot√£o "Comprovante" de qualquer atleta na lista para gerar seu comprovante personalizado.');
      } else {
        alert('Esta funcionalidade est√° dispon√≠vel apenas no modo visitante para gera√ß√£o de comprovantes pessoais.');
      }
    });

    function abrirModalComprovante() {
      if (filteredResultadosCache.length === 0) {
        alert('Nenhum resultado dispon√≠vel para gerar comprovante.');
        return;
      }
      
      atualizarPreviewComprovante();
      modalComprovante.style.display = 'flex';
    }

    function atualizarPreviewComprovante() {
      if (!atletaSelecionadoComprovante) return;
      
      const atletasMesmaCategoria = filteredResultadosCache.filter(a => 
        a.categoria === atletaSelecionadoComprovante.categoria && 
        a.modalidade === atletaSelecionadoComprovante.modalidade
      );
      const posicaoCategoria = atletasMesmaCategoria.findIndex(a => a.numero === atletaSelecionadoComprovante.numero) + 1;
      
      const posicaoGeral = filteredResultadosCache.findIndex(a => a.numero === atletaSelecionadoComprovante.numero) + 1;
      
      // EXTRAIR PRIMEIRO E √öLTIMO NOME
      const nomeCompleto = atletaSelecionadoComprovante.atleta || '';
      const partesNome = nomeCompleto.split(' ').filter(part => part.trim() !== '');
      const nomeSimplificado = partesNome.length > 1 
        ? `${partesNome[0]} ${partesNome[partesNome.length - 1]}`
        : partesNome[0] || '';
      
      comprovanteData.innerHTML = `
        <div class="comprovante-item">
          <span class="comprovante-item-label">Atleta:</span>
          <span>${escapeHtml(nomeSimplificado)}</span>
        </div>
        <div class="comprovante-item">
          <span class="comprovante-item-label">Modalidade:</span>
          <span>${escapeHtml(atletaSelecionadoComprovante.modalidade || '')}</span>
        </div>
        <div class="comprovante-item">
          <span class="comprovante-item-label">Categoria:</span>
          <span>${escapeHtml(atletaSelecionadoComprovante.categoria || '')}</span>
        </div>
        <div class="comprovante-item">
          <span class="comprovante-item-label">Tempo Final:</span>
          <span>${escapeHtml(atletaSelecionadoComprovante.tempo || '')}</span>
        </div>
        ${atletaSelecionadoComprovante.totalVoltas ? `
        <div class="comprovante-item">
          <span class="comprovante-item-label">Voltas:</span>
          <span>${atletaSelecionadoComprovante.totalVoltas}</span>
        </div>
        ` : ''}
        <div class="comprovante-item">
          <span class="comprovante-item-label">Posi√ß√£o Geral:</span>
          <span>${posicaoGeral}¬∫</span>
        </div>
        <div class="comprovante-item">
          <span class="comprovante-item-label">Posi√ß√£o Categoria:</span>
          <span>${posicaoCategoria}¬∫</span>
        </div>
        <div class="comprovante-item-centralizado">
  <span>${new Date().toLocaleDateString('pt-BR')}</span>
</div>
      `;
      
      comprovanteTexto.textContent = ` ${atletaSelecionadoComprovante.tempo || '--:--:--'}`;
    }

    // Event listeners para comprovante
    btnComprovanteStory.addEventListener('click', (e) => {
      e.stopPropagation();
      formatoComprovanteAtual = 'story';
      comprovantePreview.className = 'comprovante-story';
      atualizarPreviewComprovante();
    });

    btnComprovanteFeed.addEventListener('click', (e) => {
      e.stopPropagation();
      formatoComprovanteAtual = 'feed';
      comprovantePreview.className = 'comprovante-feed';
      atualizarPreviewComprovante();
    });

    btnFecharComprovante.addEventListener('click', (e) => {
      e.stopPropagation();
      modalComprovante.style.display = 'none';
    });

    btnDownloadComprovante.addEventListener('click', (e) => {
      e.stopPropagation();
      // Verificar se html2canvas est√° dispon√≠vel
      if (typeof html2canvas === 'undefined') {
        // Tentar carregar a biblioteca dinamicamente
        const script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
        script.onload = () => {
          baixarComprovante();
        };
        script.onerror = () => {
          alert('Funcionalidade de download temporariamente indispon√≠vel. Tente novamente em alguns instantes.');
        };
        document.head.appendChild(script);
      } else {
        baixarComprovante();
      }
    });

    function baixarComprovante() {
      if (window.html2canvas) {
        const comprovante = document.getElementById('comprovante-preview');
        const scale = 3;
        
        html2canvas(comprovante, {
          scale: scale,
          useCORS: true,
          allowTaint: true,
          backgroundColor: null
        }).then(canvas => {
          const link = document.createElement('a');
          link.download = `comprovante-${atletaSelecionadoComprovante?.numero || 'atleta'}.png`;
          link.href = canvas.toDataURL('image/png', 1.0);
          link.click();
        }).catch(err => {
          console.error('Erro ao gerar comprovante:', err);
          alert('Erro ao gerar comprovante. Tente novamente.');
        });
      } else {
        alert('Funcionalidade de download temporariamente indispon√≠vel');
      }
    }

    // Fechar modal clicando no overlay
    modalComprovante.addEventListener('click', (e) => {
      if (e.target === modalComprovante) {
        modalComprovante.style.display = 'none';
      }
    });

    // utils
    function padNum(n){ return String(n).padStart(4,'0'); }
    function parseDMYTime(s){
      if(!s) return null;
      const [datePart, timePart] = s.split(' ');
      const [d,m,y] = datePart.split('/').map(Number);
      let hh=0, mm=0, ss=0;
      if(timePart){
        [hh,mm,ss] = timePart.split(':').map(x=>Number(x));
      }
      return new Date(y, m-1, d, hh, mm, ss);
    }
    function formatDMYTime(dt){
      if(!dt) return '';
      const d = String(dt.getDate()).padStart(2,'0');
      const m = String(dt.getMonth()+1).padStart(2,'0');
      const y = String(dt.getFullYear());
      const hh = String(dt.getHours()).padStart(2,'0');
      const mm = String(dt.getMinutes()).padStart(2,'0');
      const ss = String(dt.getSeconds()).padStart(2,'0');
      return `${d}/${m}/${y} ${hh}:${mm}:${ss}`;
    }
    function formatTempoFromSeconds(totalSeconds){
      if(totalSeconds == null) return '';
      if(totalSeconds < 0) totalSeconds = 0;
      const hh = Math.floor(totalSeconds/3600);
      const mm = Math.floor((totalSeconds%3600)/60);
      const ss = Math.floor(totalSeconds%60);
      return `${String(hh).padStart(2,'0')}:${String(mm).padStart(2,'0')}:${String(ss).padStart(2,'0')}`;
    }

    // Fun√ß√£o para verificar intervalo m√≠nimo entre voltas
    function verificarIntervaloMinimo(voltasAtleta) {
      if (!voltasAtleta || voltasAtleta.length === 0) return true; // Sem voltas anteriores, pode registrar
      
      const ultimaVolta = voltasAtleta[voltasAtleta.length - 1];
      const agora = new Date();
      const ultimaVoltaDt = parseDMYTime(ultimaVolta.dataHora) || new Date(ultimaVolta.registradaEmISO);
      
      const diferencaMs = agora.getTime() - ultimaVoltaDt.getTime();
      const diferencaMinutos = diferencaMs / (1000 * 60);
      
      return diferencaMinutos >= 3; // Retorna true se passaram 3 minutos ou mais
    }

    // √öltimos 10 n√∫meros compartilhados via Firebase
    function pushLastRegistrado(num) {
      const lastRef = ref(db, 'ultimosRegistrados');
      get(lastRef).then((snap) => {
        let arr = snap.exists() ? snap.val() : [];
        arr = arr.filter(x => x !== num);
        arr.unshift(num);
        arr = arr.slice(0, 10);
        set(lastRef, arr);
      });
    }

    function renderUltimosRegistrados() {
      const el = document.getElementById('last5');
      const lastRef = ref(db, 'ultimosRegistrados');
      onValue(lastRef, (snap) => {
        el.innerHTML = '';
        const arr = snap.exists() ? snap.val() : [];
        if (!arr.length) {
          el.innerHTML = `<span class="small" style="color:#666">Nenhum registro ainda</span>`;
          return;
        }
        arr.forEach(x => {
          const div = document.createElement('div');
          div.className = 'pill';
          div.textContent = x;
          div.onclick = () => { 
            if(pageEntrada.classList.contains('hidden')) {
              numeroInput.value = x; 
              numeroInput.focus(); 
            }
          };
          el.appendChild(div);
        });
      });
    }

    function rebuildResultFilters(){
      const modalidades = new Set();
      latestListagem.forEach(r=>{ if(r.modalidade) modalidades.add(r.modalidade); });
      latestLargadas.forEach(r=>{ if(r.modalidade) modalidades.add(r.modalidade); });
      const categorias = new Set();
      latestListagem.forEach(r=>{ if(r.categoria) categorias.add(r.categoria); });
      latestResultados.forEach(r=>{ if(r.categoria) categorias.add(r.categoria); });
      const generos = new Set();
      latestListagem.forEach(r=>{ if(r.genero) generos.add(r.genero); });
      latestResultados.forEach(r=>{ if(r.genero) generos.add(r.genero); });

      fillSelect(fModalidade, [...modalidades].sort(), 'Todas');
      fillSelect(fCategoria, [...categorias].sort(), 'Todas');
      fillSelect(fGenero, [...generos].sort(), 'Todos');
    }

    function fillSelect(selectEl, arr, firstLabel){
      selectEl.innerHTML = `<option value="">${firstLabel||'Todos'}</option>`;
      arr.forEach(x=>{ const o=document.createElement('option'); o.value=x; o.textContent=x; selectEl.appendChild(o); });
    }

    btnAplicarFiltro.onclick = ()=> renderResultados(latestResultados);

    function tempoToSeconds(t){
      if(!t) return Infinity;
      const parts = t.split(':').map(x=>Number(x));
      if(parts.length===3){
        return parts[0]*3600 + parts[1]*60 + parts[2];
      }
      if(parts.length===2){
        return parts[0]*60 + parts[1];
      }
      return Number(t) || Infinity;
    }

    function calcularResultadosMtb(){
      const resultadosMtb = [];
      
      Object.keys(latestVoltasMtb).forEach(numero => {
        const voltas = latestVoltasMtb[numero];
        if(voltas && voltas.length > 0){
          const primeiraVolta = voltas[0];
          const ultimaVolta = voltas[voltas.length - 1];
          
          resultadosMtb.push({
            numero: numero,
            atleta: primeiraVolta.atleta || '',
            modalidade: 'MTB',
            categoria: primeiraVolta.categoria || '',
            genero: primeiraVolta.genero || '',
            chegada: ultimaVolta.dataHora || '',
            tempo: ultimaVolta.tempo || '',
            totalVoltas: voltas.length,
            tempoTotal: tempoToSeconds(ultimaVolta.tempo)
          });
        }
      });
      
      resultadosMtb.sort((a, b) => {
        if(b.totalVoltas !== a.totalVoltas){
          return b.totalVoltas - a.totalVoltas;
        }
        return a.tempoTotal - b.tempoTotal;
      });
      
      return resultadosMtb;
    }

    function calcularResultadosDuathlon(){
      const resultadosDuathlon = [];
      
      Object.keys(latestVoltasDuathlon).forEach(numero => {
        const voltas = latestVoltasDuathlon[numero];
        if(voltas && voltas.length > 0){
          const primeiraVolta = voltas[0];
          const ultimaVolta = voltas[voltas.length - 1];
          
          resultadosDuathlon.push({
            numero: numero,
            atleta: primeiraVolta.atleta || '',
            modalidade: 'DUATHLON CROSS',
            categoria: primeiraVolta.categoria || '',
            genero: primeiraVolta.genero || '',
            chegada: ultimaVolta.dataHora || '',
            tempo: ultimaVolta.tempo || '',
            totalVoltas: voltas.length,
            tempoTotal: tempoToSeconds(ultimaVolta.tempo)
          });
        }
      });
      
      resultadosDuathlon.sort((a, b) => {
        if(b.totalVoltas !== a.totalVoltas){
          return b.totalVoltas - a.totalVoltas;
        }
        return a.tempoTotal - b.tempoTotal;
      });
      
      return resultadosDuathlon;
    }

    function renderResultados(rows){
      const fm = fModalidade.value;
      const fc = fCategoria.value;
      const fg = fGenero.value;
      
      let filtered = rows.filter(r=>{
        if(fm && r.modalidade !== fm) return false;
        if(fc && r.categoria !== fc) return false;
        if(fg && r.genero !== fg) return false;
        return true;
      });

      // Adicionar resultados de MTB com voltas
      if((!fm || fm === 'MTB') && latestVoltasMtb && Object.keys(latestVoltasMtb).length > 0){
        const resultadosMtb = calcularResultadosMtb();
        filtered = filtered.filter(r => r.modalidade !== 'MTB');
        resultadosMtb.forEach(rm => {
          if((!fc || rm.categoria === fc) && (!fg || rm.genero === fg)){
            filtered.push(rm);
          }
        });
      }

      // Adicionar resultados de Duathlon Cross com voltas
      if((!fm || fm === 'DUATHLON CROSS') && latestVoltasDuathlon && Object.keys(latestVoltasDuathlon).length > 0){
        const resultadosDuathlon = calcularResultadosDuathlon();
        filtered = filtered.filter(r => r.modalidade !== 'DUATHLON CROSS');
        resultadosDuathlon.forEach(rd => {
          if((!fc || rd.categoria === fc) && (!fg || rd.genero === fg)){
            filtered.push(rd);
          }
        });
      }

      filtered.sort((a,b)=>{
        // Para MTB e Duathlon Cross, ordenar por voltas primeiro
        if((a.modalidade === 'MTB' || a.modalidade === 'DUATHLON CROSS') && 
           (b.modalidade === 'MTB' || b.modalidade === 'DUATHLON CROSS') && 
           a.totalVoltas && b.totalVoltas){
          if(b.totalVoltas !== a.totalVoltas){
            return b.totalVoltas - a.totalVoltas;
          }
          return (a.tempoTotal || Infinity) - (b.tempoTotal || Infinity);
        }
        
        // Para outras modalidades, ordenar por tempo
        const ta = tempoToSeconds(a.tempo);
        const tb = tempoToSeconds(b.tempo);
        if(ta === tb) {
          const da = a.registradaEmISO ? new Date(a.registradaEmISO) : (a.chegada ? parseDMYTime(a.chegada) : new Date(0));
          const dbb = b.registradaEmISO ? new Date(b.registradaEmISO) : (b.chegada ? parseDMYTime(b.chegada) : new Date(0));
          return da - dbb;
        }
        return ta - tb;
      });

      filteredResultadosCache = filtered;

      let html = `<table><thead><tr>
        <th>Posi√ß√£o</th>
        <th>N√∫mero</th>
        <th>Atleta</th>
        <th>Modalidade</th>
        <th>Categoria</th>
        <th>G√™nero</th>
        <th>Chegada</th>
        <th>Tempo</th>
        <th>Voltas</th>
        <th>A√ß√µes</th>
      </tr></thead><tbody>`;

      filtered.forEach((r, i)=>{
        const pos = (r.tempo || r.totalVoltas) ? `${i+1}¬∫` : '';
        const voltasInfo = r.totalVoltas ? `${r.totalVoltas} volta(s)` : '';
        
        html += `<tr>
          <td><strong>${pos}</strong></td>
          <td>${r.numero}</td>
          <td>${escapeHtml(r.atleta||'')}</td>
          <td>${escapeHtml(r.modalidade||'')}</td>
          <td>${escapeHtml(r.categoria||'')}</td>
          <td>${escapeHtml(r.genero||'')}</td>
          <td>${escapeHtml(r.chegada||'')}</td>
          <td>${escapeHtml(r.tempo||'')}</td>
          <td>${voltasInfo}</td>
          <td>`;
        if(!isVisitor && auth.currentUser){
          html += `<button data-num="${r.numero}" class="btn-edit-res">Editar</button>`;
        } else {
          html += `<button data-num="${r.numero}" class="btn-comprovante-res secondary">Comprovante</button>`;
        }
        html += `</td></tr>`;
      });

      html += `</tbody></table>`;
      tableResultados.innerHTML = html;
      
      if(!isVisitor && auth.currentUser){
        tableResultados.querySelectorAll('.btn-edit-res').forEach(btn=> btn.onclick = ()=> openEditResultado(btn.dataset.num) );
      } else {
        tableResultados.querySelectorAll('.btn-comprovante-res').forEach(btn=> {
          btn.onclick = () => {
            const numero = btn.dataset.num;
            const atleta = filteredResultadosCache.find(a => a.numero === numero);
            if (atleta) {
              atletaSelecionadoComprovante = atleta;
              abrirModalComprovante();
            }
          };
        });
      }
    }

    // Edit resultado modal
    async function openEditResultado(numero){
      if(isVisitor || !auth.currentUser){ alert('A√ß√£o proibida: modo visitante. Fa√ßa login para editar resultados.'); return; }
      const snap = await get(child(ref(db), `resultados/${numero}`));
      const data = snap.exists() ? snap.val() : {};
      const athleteSnap = await get(child(ref(db), `listagem/${numero}`));
      const athlete = athleteSnap.exists() ? athleteSnap.val() : {};
      const overlay = document.createElement('div'); overlay.className='overlay';
      const form = document.createElement('form'); form.className='modal';
      form.innerHTML = `
        <h4>Editar Resultado - ${numero}</h4>
        <label class="small">N√∫mero</label>
        <input id="r_numero" placeholder="N√∫mero" value="${escapeAttr(numero)}" />
        <input id="r_nome" placeholder="Nome" value="${escapeAttr(data.atleta || athlete.atleta || '')}" />
        <input id="r_modalidade" placeholder="Modalidade" value="${escapeAttr(data.modalidade || athlete.modalidade || '')}" />
        <input id="r_categoria" placeholder="Categoria" value="${escapeAttr(data.categoria || athlete.categoria || '')}" />
        <input id="r_genero" placeholder="G√™nero" value="${escapeAttr(data.genero || athlete.genero || '')}" />
        <input id="r_data_nasc" placeholder="Data Nascimento (DD/MM/YYYY)" value="${escapeAttr(data.data_nascimento || athlete.data_nascimento || '')}" />
        <input id="r_idade" placeholder="Idade" value="${escapeAttr(data.idade || athlete.idade || '')}" />
        <label class="small">Chegada (DD/MM/YYYY HH:MM:SS)</label>
        <input id="r_chegada" value="${escapeAttr(data.chegada||'')}" />
        <label class="small">Tempo (HH:MM:SS)</label>
        <input id="r_tempo" value="${escapeAttr(data.tempo||'')}" />
        <div class="form-actions">
          <button type="button" id="r_cancel" class="ghost">Cancelar</button>
          <button type="submit">Salvar</button>
        </div>
      `;
      document.body.appendChild(overlay); document.body.appendChild(form);
      form.r_cancel.onclick = ()=>{ form.remove(); overlay.remove(); };
      form.onsubmit = async (e)=>{
        e.preventDefault();
        try{
          const rawNew = (form.r_numero.value || '').replace(/\D/g,'');
          if(!rawNew){ alert('N√∫mero inv√°lido'); return; }
          const newNumero = padNum(rawNew);
          const payloadRes = {
            atleta: form.r_nome.value,
            modalidade: form.r_modalidade.value,
            categoria: form.r_categoria.value,
            genero: form.r_genero.value,
            data_nascimento: form.r_data_nasc.value,
            idade: form.r_idade.value,
            chegada: form.r_chegada.value,
            tempo: form.r_tempo.value,
            registradaEmISO: new Date().toISOString()
          };
          const payloadList = {
            atleta: form.r_nome.value,
            modalidade: form.r_modalidade.value,
            categoria: form.r_categoria.value,
            genero: form.r_genero.value,
            data_nascimento: form.r_data_nasc.value,
            idade: form.r_idade.value
          };
          if(newNumero === numero){
            await update(ref(db, `resultados/${numero}`), payloadRes);
            await update(ref(db, `listagem/${numero}`), payloadList);
          } else {
            const existsNewList = (await get(child(ref(db), `listagem/${newNumero}`))).exists();
            if(existsNewList){
              if(!confirm(`J√° existe atleta com n√∫mero ${newNumero} em listagem. Deseja sobrescrever?`)) { return; }
            }
            const existsNewRes = (await get(child(ref(db), `resultados/${newNumero}`))).exists();
            if(existsNewRes){
              if(!confirm(`J√° existe resultado com n√∫mero ${newNumero}. Deseja sobrescrever?`)) { return; }
            }
            await set(ref(db, `listagem/${newNumero}`), payloadList);
            await remove(ref(db, `listagem/${numero}`));
            await set(ref(db, `resultados/${newNumero}`), Object.assign({}, payloadRes, { registradoPor: auth.currentUser ? auth.currentUser.email : null }));
            await remove(ref(db, `resultados/${numero}`));
          }
          form.remove(); overlay.remove();
        }catch(err){ console.error(err); alert('Erro ao salvar: '+(err.message||err)); }
      };
    }

    // Export CSV
    btnExport.onclick = ()=>{
      const rows = filteredResultadosCache.length ? filteredResultadosCache : latestResultados;
      if(!rows || !rows.length){ alert('Nenhum resultado para exportar'); return; }
      const header = ['numero','atleta','modalidade','categoria','genero','chegada','tempo','voltas'];
      const csv = [header.join(',')].concat(rows.map(r=> {
        const rowData = [
          r.numero || '',
          r.atleta || '',
          r.modalidade || '',
          r.categoria || '',
          r.genero || '',
          r.chegada || '',
          r.tempo || '',
          r.totalVoltas || ''
        ];
        return rowData.map(cell => `"${String(cell).replace(/"/g,'""')}"`).join(',');
      })).join('\n');
      const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'resultados_export.csv';
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    };

    // search handler and utils
    searchListagem.addEventListener('input', ()=> renderListagem(latestListagem) );

    function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, (m)=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
    function escapeAttr(s){ return escapeHtml(s).replace(/"/g,'&quot;'); }

    // initial UI
    showPage('entrada');

  </script>
</body>
</html>
